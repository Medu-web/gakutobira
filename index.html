<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ãƒˆãƒ“ãƒ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Tailwind CSS ä»¥å¤–ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #f4f7f6;
            color: #333;
        }
        
        /* ãƒ‰ã‚¢ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .door-icon {
            position: relative;
            width: 24px;
            height: 32px;
            background-color: #a0522d;
            border: 2px solid #8B4513;
            border-radius: 4px 4px 0 0;
            margin-right: 15px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
            transform-origin: left center;
            transition: transform 0.5s ease-out, opacity 0.5s ease-out; 
            transform: rotateY(0deg);
        }
        .link-button.opening .door-icon {
            transform: rotateY(-110deg);
            opacity: 0;
        }
        .door-icon::after {
            content: '';
            position: absolute;
            top: 10px;
            right: 5px;
            width: 4px;
            height: 4px;
            background-color: #ffd700;
            border-radius: 50%;
        }
        
        /* ç·Šæ€¥ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
        .emergency-button .door-icon {
            background-color: #cc3333; 
            border-color: #a00000;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
        }
        
        /* ãƒ•ã‚©ãƒ¼ãƒ ã®èª¿æ•´ */
        .link-row {
            transition: background-color 0.2s;
        }
        .link-row:hover {
            background-color: #f0f4f8;
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="container max-w-4xl mx-auto p-4 md:p-8 bg-white shadow-xl rounded-xl">
        
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã¨èªè¨¼æƒ…å ± -->
        <header class="flex justify-between items-start mb-6 border-b pb-3">
            <div>
                <h1 class="text-3xl md:text-4xl font-extrabold text-blue-700 tracking-tight"><ruby>å­¦<rt class="text-gray-500 text-base font-normal">ã‚¬ã‚¯</rt></ruby>ãƒˆãƒ“ãƒ©</h1>
                <p class="text-sm text-gray-500 mt-1">å­¦ç¿’ã®æ‰‰ã‚’é–‹ã“ã†ï¼ (ãƒ‡ãƒ¼ã‚¿ã¯Firestoreã«ä¿å­˜ã•ã‚Œã¾ã™)</p>
            </div>
            
            <div id="auth-status" class="text-right">
                <p class="text-xs font-semibold" id="user-status-text">èªè¨¼ä¸­...</p>
                <button id="edit-button" class="mt-2 px-3 py-1 bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-bold rounded-lg shadow-md transition hidden" onclick="showEditModal()">
                    <span id="current-portal-key-display" class="font-normal text-xs mr-1"></span> ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
                </button>
            </div>
        </header>

        <!-- ãƒ‡ãƒ¢ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ (ç®¡ç†è€…ç”¨) -->
        <div id="demo-nav-container" class="demo-nav p-4 bg-indigo-50 border border-indigo-200 rounded-lg mb-8 transition-all hidden">
            <h3 class="text-lg font-semibold text-indigo-700 border-b border-indigo-300 pb-2 mb-3">ãƒ‡ãƒ¢ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰: #admin ã§è¡¨ç¤ºï¼‰</h3>
            <span class="text-xs font-medium text-red-600 block mb-3">ç¾åœ¨ã®ãƒãƒ¼ã‚¿ãƒ«ã‚­ãƒ¼: <span id="current-hash-display">#default</span></span>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                <span class="col-span-full font-bold text-gray-700 mt-2">å°å­¦æ ¡ (01, 21)</span>
                <a href="#s/01/all" class="p-2 bg-white rounded-md hover:bg-indigo-100 text-indigo-600 font-medium text-center shadow-sm">ä¸€å° å…¨æ ¡</a>
                <a href="#s/01/g1/all" class="p-2 bg-white rounded-md hover:bg-indigo-100 text-indigo-600 font-medium text-center shadow-sm">ä¸€å° 1å¹´ç”Ÿ</a>
                <a href="#s/21/g5/all" class="p-2 bg-white rounded-md hover:bg-indigo-100 text-indigo-600 font-medium text-center shadow-sm">é›·å¡š 5å¹´ (FB)</a>
                <span class="col-span-full font-bold text-gray-700 mt-2">ä¸­å­¦æ ¡ (12, 14)</span>
                <a href="#s/12/all" class="p-2 bg-white rounded-md hover:bg-indigo-100 text-indigo-600 font-medium text-center shadow-sm">äºŒä¸­ å…¨æ ¡</a>
                <a href="#s/12/g7/all" class="p-2 bg-white rounded-md hover:bg-indigo-100 text-indigo-600 font-medium text-center shadow-sm">äºŒä¸­ 7å¹´ç”Ÿ</a>
                <a href="#s/14/all" class="p-2 bg-white rounded-md hover:bg-indigo-100 text-indigo-600 font-medium text-center shadow-sm">å››ä¸­ å…¨æ ¡</a>
                <span class="col-span-full font-bold text-gray-700 mt-2">å…±é€š/ãƒ†ã‚¹ãƒˆ</span>
                <a href="#default" class="p-2 bg-green-100 rounded-md hover:bg-green-200 text-green-700 font-medium text-center shadow-sm">#default</a>
                <a href="#s/999/g5/all" class="p-2 bg-red-100 rounded-md hover:bg-red-200 text-red-700 font-medium text-center shadow-sm">#999 (FBãƒ†ã‚¹ãƒˆ)</a>
                <a href="#admin" class="p-2 bg-purple-100 rounded-md hover:bg-purple-200 text-purple-700 font-medium text-center shadow-sm">#admin (ç®¡ç†)</a>
            </div>
        </div>

        <!-- å­¦ç¿’Webã‚¢ãƒ—ãƒªã‚»ã‚¯ã‚·ãƒ§ãƒ³ (ãƒ¡ã‚¤ãƒ³) -->
        <div id="main-content">
            <h2 class="text-2xl font-bold text-blue-700 border-b-4 border-blue-600 pb-2 mb-6" id="main-section-title">ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ä¸­...</h2>
            
            <div id="link-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="col-span-full text-center py-10 text-gray-500">
                    <div class="spinner mx-auto mb-3 border-blue-500 border-t-blue-700"></div>
                    <p>ãƒãƒ¼ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™...</p>
                </div>
            </div>
        </div>

        <!-- ç·Šæ€¥å¯¾å¿œã‚»ã‚¯ã‚·ãƒ§ãƒ³ (ãƒˆãƒ©ãƒ–ãƒ«å›é¿) -->
        <div class="mt-10 p-5 border-4 border-red-600 bg-red-50 rounded-xl shadow-lg">
            <h2 class="text-xl font-bold text-red-700 border-b-2 border-red-500 pb-2 mb-4">ğŸš¨ ç·Šæ€¥å¯¾å¿œã®æ‰‰ï¼šã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚„ãƒ‡ãƒ¼ã‚¿æ¶ˆå¤±ã®ãƒˆãƒ©ãƒ–ãƒ«æ™‚</h2>
            <p class="text-red-600 font-bold mb-4 text-sm">
                **ã€é‡è¦ã€‘** OneDriveãƒ•ã‚©ãƒ«ãƒ€ã‚„ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚¢ãƒ—ãƒª(Teams/Office)ã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã§ããªã„å ´åˆã¯ã€**å¿…ãšã“ã®ãƒªãƒ³ã‚¯**ã‹ã‚‰Webãƒ–ãƒ©ã‚¦ã‚¶ç‰ˆã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚
            </p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <a href="https://portal.office.com/" class="link-button emergency-button flex items-center justify-center p-4 bg-yellow-500 hover:bg-yellow-600 text-gray-900 rounded-lg font-bold shadow-md transition">
                    <span class="door-icon"></span><span class="text-base text-center">Microsoftã®ã‚¹ã‚¿ãƒ¼ãƒˆãƒšãƒ¼ã‚¸<br>(Webç‰ˆ Office, Teams, OneDrive)</span>
                </a>

                <a href="[ã‚µã‚¤ãƒ³ã‚¤ãƒ³æ‰‹é †æ›¸PDFã®URLã‚’ã“ã“ã«è¨˜è¿°]" class="link-button emergency-button flex items-center justify-center p-4 bg-yellow-500 hover:bg-yellow-600 text-gray-900 rounded-lg font-bold shadow-md transition">
                    <span class="door-icon"></span><span class="text-base text-center">ã‚µã‚¤ãƒ³ã‚¤ãƒ³å¾©æ—§æ‰‹é †æ›¸<br>ï¼ˆãƒˆãƒ©ãƒ–ãƒ«è§£æ±ºãƒãƒ‹ãƒ¥ã‚¢ãƒ«ï¼‰</span>
                </a>
            </div>
        </div>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼æƒ…å ± -->
        <div class="mt-10 pt-5 border-t border-gray-300 text-center text-sm text-gray-500">
            <p>ãƒãƒ¼ã‚¿ãƒ«ã‚µã‚¤ãƒˆè¨­å®šã¯Firestoreã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
        </div>
    </div>
    
    <!-- ------------------------------------- -->
    <!-- ãƒªãƒ³ã‚¯ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <!-- ------------------------------------- -->
    <div id="edit-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center hidden" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full p-6 m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start border-b pb-3 mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-blue-700">ãƒªãƒ³ã‚¯è¨­å®šã®ç·¨é›†</h3>
                <button onclick="hideEditModal()" class="text-gray-400 hover:text-gray-600 transition" aria-label="é–‰ã˜ã‚‹">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <p class="text-sm text-gray-600 mb-4">
                ç¾åœ¨ç·¨é›†ä¸­ã®ã‚­ãƒ¼: <span id="editing-key-display" class="font-mono bg-gray-100 px-1 rounded text-red-600"></span>
            </p>
            
            <div id="links-editor">
                <!-- ãƒªãƒ³ã‚¯å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
            </div>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button onclick="addLinkField()" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg transition shadow-md">
                    ãƒªãƒ³ã‚¯ã‚’è¿½åŠ 
                </button>
                <button onclick="saveEditedLinks()" id="save-button" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition shadow-md">
                    <span id="save-text">è¨­å®šã‚’ä¿å­˜</span>
                    <div id="save-spinner" class="spinner border-t-white hidden"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- ------------------------------------- -->
    <!-- Firebase SDKã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¨åˆæœŸåŒ– -->
    <!-- ------------------------------------- -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestoreãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’ãƒ‡ãƒãƒƒã‚°ã«è¨­å®š (é–‹ç™ºç”¨)
        setLogLevel('debug');

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° (Canvasç’°å¢ƒã‹ã‚‰æä¾›ã•ã‚Œã‚‹ã‚‚ã®ã‚’å„ªå…ˆ)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // ã“ã“ã«Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®Configæƒ…å ±ã‚’è²¼ã‚Šä»˜ã‘ã‚‹ã“ã¨ã§ã€GitHub Pagesãªã©ã®ç’°å¢ƒã§å‹•ä½œã—ã¾ã™ã€‚
        // Canvasç’°å¢ƒã§ã¯ __firebase_config ãŒè‡ªå‹•çš„ã«æä¾›ã•ã‚Œã¾ã™ã€‚
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { /* // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCU6-hKFFa8dew_G_0_hDP8Q4eYqP0_7yU",
  authDomain: "gigaportal-editor.firebaseapp.com",
  projectId: "gigaportal-editor",
  storageBucket: "gigaportal-editor.firebasestorage.app",
  messagingSenderId: "969946487756",
  appId: "1:969946487756:web:fa4c4347d72de0b2dc9b69"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig); */ };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = 'loading'; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
        let isAuthReady = false; // èªè¨¼æº–å‚™å®Œäº†ãƒ•ãƒ©ã‚°
        let currentHash = 'default'; // ç¾åœ¨ã®ãƒãƒ¼ã‚¿ãƒ«ã‚­ãƒ¼ (URLãƒãƒƒã‚·ãƒ¥ã‹ã‚‰æ±ºå®š)

        // ----------------------------------------------------
        // ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–ã¨å–å¾—ã«é–¢ã™ã‚‹å®šæ•°ã¨é–¢æ•°
        // ----------------------------------------------------

        // Firestoreã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ã‚¹ (å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å…±æœ‰ãƒ»ç·¨é›†å¯èƒ½)
        function getPortalConfigDocRef(docId) {
            return doc(db, 'artifacts', appId, 'public', 'data', 'portal_configs', docId);
        }

        // URLãƒãƒƒã‚·ãƒ¥ï¼ˆä¾‹: s/01/g6/allï¼‰ã‚’Firestoreã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDï¼ˆä¾‹: s_01_g6_allï¼‰ã«å¤‰æ›
        function getDocIdFromHash(hash) {
            return hash.replace(/^#/, '').replace(/\//g, '_');
        }

        /**
         * å…±é€šã§åˆ©ç”¨ã™ã‚‹ãƒªãƒ³ã‚¯ã‚»ãƒƒãƒˆ (åˆæœŸãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä½¿ç”¨)
         * Firestoreã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã«ã“ã®åˆæœŸå€¤ã‚’ä¿å­˜ã—ã¾ã™ã€‚
         */
        const initialPortalData = {
            'default': {
                title: 'ğŸ’¡ å…±é€šå­¦ç¿’ã®æ‰‰',
                links: [
                    { name: "eãƒ©ã‚¤ãƒ–ãƒ©ãƒª", url: "https://ela.education.ne.jp/students/" },
                    { name: "ãƒ‰ãƒªãƒ«ãƒ—ãƒ©ãƒãƒƒãƒˆ", url: "https://login.kobun.co.jp/student-login/?code=1134304" },
                    { name: "ã‚­ãƒ¼ãƒœãƒ¼å³¶ (ã‚¿ã‚¤ãƒ”ãƒ³ã‚°)", url: "https://kb-kentei.net/" },
                    { name: "æ•™è‚²å§”å“¡ä¼šWebã‚µã‚¤ãƒˆ", url: "#" },
                ]
            },
            's_01_all': { title: 'ğŸ« ç¬¬ä¸€å°å­¦æ ¡ å…¨æ ¡å…±é€šã®æ‰‰', links: [ { name: "ä¸€å°-å­¦æ ¡ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›", url: "#" }, { name: "ä¸€å°-å…ˆç”Ÿã¸ã®è³ªå•ãƒ•ã‚©ãƒ¼ãƒ ", url: "#" }, { name: "ä¸€å°-ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°æ•™æ", url: "#" } ] },
            's_01_g1_all': { title: 'âœï¸ ç¬¬ä¸€å°å­¦æ ¡ 1å¹´ç”Ÿã®æ‰‰', links: [ { name: "1å¹´ ç®—æ•°ãƒ‰ãƒªãƒ«", url: "#" }, { name: "ã²ã‚‰ãŒãªç·´ç¿’ã‚µã‚¤ãƒˆ", url: "#" }, { name: "ç”Ÿæ´»ç§‘ Webã‚µã‚¤ãƒˆ", url: "#" } ] },
            's_01_g6_all': { title: 'âœï¸ ç¬¬ä¸€å°å­¦æ ¡ 6å¹´ç”Ÿã®æ‰‰', links: [ { name: "6å¹´ å’æ¥­æ–‡é›†ä½œæˆ", url: "#" }, { name: "6å¹´ èª²é¡Œæå‡ºãƒ•ã‚©ãƒ«ãƒ€", url: "#" }, { name: "ä¸­å­¦æ ¡ç”Ÿæ´»ç´¹ä»‹", url: "#" } ] },
            's_12_all': { title: 'ğŸ« ç¬¬äºŒä¸­å­¦æ ¡ å…¨æ ¡å…±é€šã®æ‰‰', links: [ { name: "äºŒä¸­-å­¦ç¿’æ”¯æ´ã‚·ã‚¹ãƒ†ãƒ  (LMS)", url: "#" }, { name: "äºŒä¸­-é€²è·¯æƒ…å ±ãƒãƒ¼ã‚¿ãƒ«", url: "#" }, { name: "äºŒä¸­-ç”Ÿå¾’ä¼š Webã‚µã‚¤ãƒˆ", url: "#" } ] },
            's_12_g7_all': { title: 'ğŸ“ ç¬¬äºŒä¸­å­¦æ ¡ 7å¹´ç”Ÿã®æ‰‰', links: [ { name: "7å¹´ è‹±èªå­¦ç¿’ã‚µã‚¤ãƒˆ", url: "#" }, { name: "7å¹´ ç†ç§‘å®Ÿé¨“è¨˜éŒ²", url: "#" }, { name: "å­¦æ ¡ç”Ÿæ´»ã‚ªãƒªã‚¨ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³", url: "#" } ] },
            's_12_g9_all': { title: 'ğŸ“ ç¬¬äºŒä¸­å­¦æ ¡ 9å¹´ç”Ÿã®æ‰‰', links: [ { name: "9å¹´ å—é¨“å¯¾ç­–ãƒ‰ãƒªãƒ«", url: "#" }, { name: "9å¹´ é€²è·¯é¢è«‡äºˆç´„", url: "#" }, { name: "å’æ¥­åˆ¶ä½œ ç™ºè¡¨ã‚µã‚¤ãƒˆ", url: "#" } ] },
            's_21_all': { title: 'ğŸ« é›·å¡šå°å­¦æ ¡ å…¨æ ¡å…±é€šã®æ‰‰', links: [ { name: "é›·å¡šå°-é€£çµ¡äº‹é …", url: "#" }, { name: "é›·å¡šå°-Webãƒ‰ãƒªãƒ«", url: "#" } ] },
        };
        
        // ----------------------------------------------------
        // FirebaseåˆæœŸåŒ–ã¨èªè¨¼
        // ----------------------------------------------------
        function initializeFirebase() {
            try {
                // Firebase ConfigãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (!firebaseConfig || !firebaseConfig.projectId) {
                    console.warn("Firebase ConfigãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒ¼ã‚¿ã¯æ°¸ç¶šåŒ–ã•ã‚Œã¾ã›ã‚“ã€‚");
                    document.getElementById('user-status-text').textContent = `Configæœªè¨­å®š`;
                    // ConfigãŒãªã„å ´åˆã€èªè¨¼ã›ãšã«ãƒ­ãƒ¼ã‚«ãƒ«ã§å‡¦ç†ã‚’é€²ã‚ã‚‹ã“ã¨ã‚‚å¯èƒ½ã ãŒã€ã“ã“ã§ã¯Firebaseã‚’å¿…é ˆã¨ã™ã‚‹
                    // isAuthReadyã‚’falseã®ã¾ã¾ã«ã—ã€UIã‚’æ›´æ–°ã—ãªã„ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®ã¾ã¾ï¼‰
                    return; 
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-status-text').textContent = `èªè¨¼æ¸ˆã¿ (ID: ${userId.substring(0, 8)}...)`;
                        // èªè¨¼ãŒå®Œäº†ã—ãŸã‚‰ãƒãƒ¼ã‚¿ãƒ«ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰é–‹å§‹ï¼‰
                        isAuthReady = true;
                        renderPortal();
                        // ç·¨é›†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                        document.getElementById('edit-button').classList.remove('hidden');
                    } else {
                        // åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³ã¾ãŸã¯ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’å®Ÿè¡Œ
                        await handleSignIn();
                    }
                });

            } catch (error) {
                console.error("Firebaseã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
                document.getElementById('user-status-text').textContent = `åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼`;
            }
        }
        
        async function handleSignIn() {
             try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
                document.getElementById('user-status-text').textContent = `ã‚µã‚¤ãƒ³ã‚¤ãƒ³å¤±æ•—`;
            }
        }

        // ----------------------------------------------------
        // Firestoreã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼)
        // ----------------------------------------------------
        let unsubscribe = null; // onSnapshotã®ãƒªã‚¹ãƒŠãƒ¼ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let currentDocId = null; // ç¾åœ¨ç›£è¦–ä¸­ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID

        async function loadLinks(hashKey) {
            if (!isAuthReady) return;

            const docId = getDocIdFromHash(hashKey);

            // ç¾åœ¨ç›£è¦–ä¸­ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ç•°ãªã‚Œã°ã€å‰ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
            if (unsubscribe && currentDocId !== docId) {
                unsubscribe();
                unsubscribe = null;
            }

            currentDocId = docId;
            const docRef = getPortalConfigDocRef(docId);

            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            unsubscribe = onSnapshot(docRef, async (docSnap) => {
                let data = null;

                if (docSnap.exists()) {
                    // ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚Œã°ãã‚Œã‚’ä½¿ç”¨
                    data = docSnap.data();
                    console.log(`Firestoreã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ (${docId})`);
                } else {
                    // ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã€åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã€Firestoreã«æ›¸ãè¾¼ã‚€
                    const initialData = initialPortalData[docId] || initialPortalData['default'];
                    if (initialData) {
                        data = initialData;
                        console.warn(`Firestoreã«ãƒ‡ãƒ¼ã‚¿ãªã—ã€‚åˆæœŸãƒ‡ãƒ¼ã‚¿ (${docId}) ã§ä¿å­˜ã—ã¾ã™ã€‚`);
                        // åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã«æ›¸ãè¾¼ã‚€
                        await setDoc(docRef, initialData).catch(e => console.error("åˆæœŸãƒ‡ãƒ¼ã‚¿ä¿å­˜å¤±æ•—:", e));
                    }
                }

                if (data) {
                    // å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã§ãƒãƒ¼ã‚¿ãƒ«UIã‚’æ›´æ–°
                    updatePortalUI(data, hashKey, docId);
                } else {
                    // æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    updatePortalUI(initialPortalData['default'], hashKey, 'default');
                    console.error("æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: defaultãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨");
                }
            }, (error) => {
                console.error("Firestore onSnapshot ã‚¨ãƒ©ãƒ¼:", error);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¡¨ç¤º
                updatePortalUI(initialPortalData['default'], hashKey, 'default');
            });
        }
        
        // ----------------------------------------------------
        // ãƒãƒ¼ã‚¿ãƒ«UIã®æ›´æ–°
        // ----------------------------------------------------
        function updatePortalUI(data, originalHash, docId) {
            const container = document.getElementById('link-container');
            const titleElement = document.getElementById('main-section-title');
            
            // UIè¡¨ç¤ºã‚­ãƒ¼ã®æ›´æ–°
            document.getElementById('current-portal-key-display').textContent = `#${originalHash}`;

            // ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
            const keyDisplay = docId !== getDocIdFromHash(originalHash) ? ` (FB: ${docId})` : '';
            titleElement.innerHTML = `<span class="text-2xl font-bold text-blue-700">${data.title}</span> <span style="font-size: 0.7em; color: #888; display: block; margin-top: 5px;">(Key: #${originalHash}${keyDisplay})</span>`;
            
            // æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢
            container.innerHTML = '';

            // ãƒªãƒ³ã‚¯ã‚’å‹•çš„ã«ç”Ÿæˆ
            if (data.links && data.links.length > 0) {
                 data.links.forEach(link => {
                    const linkElement = document.createElement('a');
                    linkElement.href = link.url;
                    linkElement.className = 'link-button flex items-center p-4 bg-blue-50 hover:bg-blue-100 text-blue-800 rounded-lg font-bold shadow-md transition';
                    
                    linkElement.innerHTML = `<span class="door-icon"></span><span class="text-base text-left">${link.name}</span>`;
                    container.appendChild(linkElement);
                });
            } else {
                container.innerHTML = `<div class="col-span-full text-center py-10 text-gray-500">ã“ã®ãƒãƒ¼ã‚¿ãƒ«ã«ã¯ã¾ã ãƒªãƒ³ã‚¯ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã€Œç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã€ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>`;
            }

            // å‹•çš„ã«ç”Ÿæˆã•ã‚ŒãŸãƒªãƒ³ã‚¯ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š
            attachAnimationListeners();
        }

        // ----------------------------------------------------
        // URLãƒãƒƒã‚·ãƒ¥å‡¦ç†ã¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯
        // ----------------------------------------------------
        function renderPortal() {
            // èªè¨¼ãŒã¾ã å®Œäº†ã—ã¦ã„ãªã„ã‹ã€ConfigãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
            if (!isAuthReady) {
                 console.log("èªè¨¼å¾…ã¡...");
                 return;
            }

            // URLãƒãƒƒã‚·ãƒ¥ã‹ã‚‰ã‚­ãƒ¼ã‚’å–å¾—ã—ã€å°æ–‡å­—åŒ–
            const hash = window.location.hash.substring(1).toLowerCase();
            const demoNavContainer = document.getElementById('demo-nav-container');

            // 1. ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
            if (hash === 'admin') {
                demoNavContainer.classList.remove('hidden');
                document.getElementById('link-container').innerHTML = '<div class="col-span-full text-center py-10 text-gray-500">ãƒ‡ãƒ¢ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒªãƒ³ã‚¯ã‚’é¸æŠã—ã¦ãƒ†ã‚¹ãƒˆã—ã€ã€Œç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã€ã§è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>';
                document.getElementById('main-section-title').innerHTML = `<span class="text-2xl font-bold text-blue-700">âš™ï¸ ãƒãƒ¼ã‚¿ãƒ«ç®¡ç†ã‚¢ã‚¯ã‚»ã‚¹</span>`;
                document.getElementById('current-hash-display').textContent = `#admin`;
                
                // Firestoreãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
                if (unsubscribe) {
                    unsubscribe();
                    unsubscribe = null;
                }
                return;
            } else {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ãƒ‡ãƒ¢ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
                demoNavContainer.classList.add('hidden');
            }
            
            // 2. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯ã‚’é©ç”¨ã—ã¦æœ€çµ‚çš„ãªã‚­ãƒ¼ã‚’æ±ºå®š
            let finalHash = hash || 'default';

            // å­¦å¹´æŒ‡å®š -> å­¦æ ¡å…±é€šã¸ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è©¦ã¿ã‚‹ï¼ˆFirestoreã‚­ãƒ¼ãŒãªã‘ã‚Œã°ï¼‰
            const parts = finalHash.split('/');
            if (parts.length === 4 && parts[3] === 'all') { 
                const schoolFallbackKey = `${parts[0]}/${parts[1]}/all`;
                const schoolFallbackDocId = getDocIdFromHash(schoolFallbackKey);
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ã®åˆæœŸãƒ‡ãƒ¼ã‚¿ã«å­¦æ ¡å…±é€šè¨­å®šãŒã‚ã‚Œã°ã€ãã‚Œã‚’æœ€çµ‚ã‚­ãƒ¼ã¨ã—ã¦ä½¿ç”¨
                if (initialPortalData[schoolFallbackDocId]) {
                    finalHash = schoolFallbackKey;
                }
            }
            
            // æœ€çµ‚ãƒã‚§ãƒƒã‚¯: åˆæœŸãƒ‡ãƒ¼ã‚¿ã«ã‚­ãƒ¼ãŒãªã„å ´åˆã€defaultã‚’ä½¿ç”¨
            const docId = getDocIdFromHash(finalHash);
            if (!initialPortalData[docId]) {
                finalHash = 'default';
            }
            
            currentHash = finalHash; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ç¾åœ¨ã®ãƒãƒƒã‚·ãƒ¥ã‚’ä¿å­˜
            
            // URLãƒãƒƒã‚·ãƒ¥è¡¨ç¤ºã‚’æ›´æ–°
            document.getElementById('current-hash-display').textContent = `#${currentHash}`;
            
            // æ±ºå®šã—ãŸã‚­ãƒ¼ã§Firestoreã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
            loadLinks(currentHash);
        }

        // ----------------------------------------------------
        // UIã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†
        // ----------------------------------------------------
        const animationDuration = 500;
        
        function handleLinkClick(e) {
            if (this.href.includes('[')) return; 
            
            if (this.href.endsWith('#') || this.href === '') {
                 e.preventDefault();
            } else {
                 e.preventDefault();
            }

            const targetUrl = this.href;
            this.classList.add('opening');

            setTimeout(() => {
                if (!this.href.endsWith('#') && this.href !== '') {
                    window.open(targetUrl, '_blank');
                }
                setTimeout(() => {
                     this.classList.remove('opening');
                }, 100);
            }, animationDuration + 50); 
        }

        function attachAnimationListeners() {
            const linkButtons = document.querySelectorAll('.link-button');
            linkButtons.forEach(button => {
                button.removeEventListener('click', handleLinkClick); 
                button.addEventListener('click', handleLinkClick);
            });
        }
        
        // ----------------------------------------------------
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®é–¢æ•°
        // ----------------------------------------------------
        let editingLinksData = [];
        let editingTitle = '';
        
        function showEditModal() {
            document.getElementById('editing-key-display').textContent = `#${currentHash}`;
            
            // ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒªãƒ³ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const docId = getDocIdFromHash(currentHash);
            const docRef = getPortalConfigDocRef(docId);

            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå‰ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆonSnapshotã®ãƒ‡ãƒ¼ã‚¿ãŒæœ€æ–°ã®ã¯ãšã ãŒã€å¿µã®ãŸã‚ï¼‰
            getDoc(docRef).then(docSnap => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    editingLinksData = data.links || [];
                    editingTitle = data.title || '';
                } else {
                     // ãƒªãƒ³ã‚¯ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                    const initialData = initialPortalData[docId] || initialPortalData['default'];
                    editingLinksData = initialData.links || [];
                    editingTitle = initialData.title || '';
                }
                
                // ã‚¿ã‚¤ãƒˆãƒ«ã‚‚ç·¨é›†å¯èƒ½ã«ã™ã‚‹
                document.getElementById('modal-title').textContent = `ãƒªãƒ³ã‚¯è¨­å®šã®ç·¨é›† (${editingTitle})`;
                
                renderLinkEditor();
                document.getElementById('edit-modal').classList.remove('hidden');
            }).catch(e => {
                console.error("ç·¨é›†ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—:", e);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯é–‹ããŒã€ãƒ‡ãƒ¼ã‚¿ã¯ç©ºã¾ãŸã¯åˆæœŸå€¤
                editingLinksData = [];
                renderLinkEditor();
                document.getElementById('edit-modal').classList.remove('hidden');
            });
        }

        function hideEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
        }

        function renderLinkEditor() {
            const editor = document.getElementById('links-editor');
            editor.innerHTML = `
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">ãƒãƒ¼ã‚¿ãƒ«ã‚¿ã‚¤ãƒˆãƒ« (ä¾‹: 1å¹´ç”Ÿã®æ‰‰)</label>
                    <input id="edit-title" type="text" value="${editingTitle}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            `;

            editingLinksData.forEach((link, index) => {
                editor.appendChild(createLinkField(link, index));
            });
        }

        function createLinkField(link, index) {
            const div = document.createElement('div');
            div.className = 'link-row flex space-x-2 items-center mb-3 p-2 border border-gray-200 rounded-md shadow-sm';
            div.dataset.index = index;
            
            // ãƒªãƒ³ã‚¯åå…¥åŠ›
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.placeholder = 'ãƒªãƒ³ã‚¯å';
            nameInput.value = link.name;
            nameInput.className = 'w-1/3 border border-gray-300 rounded-md p-2 text-sm focus:ring-blue-500 focus:border-blue-500';
            nameInput.dataset.field = 'name';
            
            // URLå…¥åŠ›
            const urlInput = document.createElement('input');
            urlInput.type = 'url';
            urlInput.placeholder = 'URL (https://...)';
            urlInput.value = link.url;
            urlInput.className = 'w-1/2 border border-gray-300 rounded-md p-2 text-sm focus:ring-blue-500 focus:border-blue-500';
            urlInput.dataset.field = 'url';
            
            // å‰Šé™¤ãƒœã‚¿ãƒ³
            const deleteButton = document.createElement('button');
            deleteButton.innerHTML = `<svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3m-4 0h12"></path></svg>`;
            deleteButton.className = 'w-1/6 p-2 rounded-md hover:bg-red-100 transition';
            deleteButton.onclick = () => removeLinkField(div);

            div.appendChild(nameInput);
            div.appendChild(urlInput);
            div.appendChild(deleteButton);

            // å…¥åŠ›å¤‰æ›´æ™‚ã®å‡¦ç†ã‚’ã‚¢ã‚¿ãƒƒãƒ
            [nameInput, urlInput].forEach(input => {
                input.addEventListener('input', updateLinkData);
            });
            
            return div;
        }

        function addLinkField() {
            const newLink = { name: '', url: '' };
            editingLinksData.push(newLink);
            const newIndex = editingLinksData.length - 1;
            
            const editor = document.getElementById('links-editor');
            editor.appendChild(createLinkField(newLink, newIndex));
        }

        function updateLinkData(e) {
            const row = e.target.closest('.link-row');
            const index = parseInt(row.dataset.index);
            const field = e.target.dataset.field;
            
            if (editingLinksData[index]) {
                editingLinksData[index][field] = e.target.value;
            }
        }

        function removeLinkField(rowElement) {
            const indexToRemove = parseInt(rowElement.dataset.index);
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
            editingLinksData.splice(indexToRemove, 1);
            
            // UIã‹ã‚‰å‰Šé™¤
            rowElement.remove();
            
            // æ®‹ã‚Šã®è¦ç´ ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å†æ§‹ç¯‰ï¼ˆé¢å€’ã ãŒç¢ºå®Ÿãªæ–¹æ³•ï¼‰
            const editor = document.getElementById('links-editor');
            editor.querySelectorAll('.link-row').forEach((row, newIndex) => {
                row.dataset.index = newIndex;
            });
            // ã‚¨ãƒ‡ã‚£ã‚¿ã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¦ã‚‚è‰¯ã„ãŒã€ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«å†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        }

        async function saveEditedLinks() {
            const saveButton = document.getElementById('save-button');
            const saveText = document.getElementById('save-text');
            const saveSpinner = document.getElementById('save-spinner');

            // UIã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«
            saveText.classList.add('hidden');
            saveSpinner.classList.remove('hidden');
            saveButton.disabled = true;

            try {
                // ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒªãƒ³ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const newTitle = document.getElementById('edit-title').value;
                const newLinks = editingLinksData.filter(link => link.name.trim() !== '' || link.url.trim() !== '');

                const dataToSave = {
                    title: newTitle,
                    links: newLinks
                };

                const docId = getDocIdFromHash(currentHash);
                const docRef = getPortalConfigDocRef(docId);
                
                await setDoc(docRef, dataToSave);
                
                console.log(`è¨­å®šã‚’Firestoreã«ä¿å­˜ã—ã¾ã—ãŸ: ${docId}`);
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                saveText.textContent = 'ä¿å­˜å®Œäº†ï¼';
                saveText.classList.remove('hidden');
                
                setTimeout(() => {
                    hideEditModal();
                    // UIã‚’å…ƒã«æˆ»ã™
                    saveText.textContent = 'è¨­å®šã‚’ä¿å­˜';
                    saveSpinner.classList.add('hidden');
                    saveButton.disabled = false;
                }, 1000);

            } catch (error) {
                console.error("è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
                saveText.textContent = 'ä¿å­˜å¤±æ•— (F12ã§ç¢ºèª)';
                saveText.classList.remove('hidden');
                
                setTimeout(() => {
                     // UIã‚’å…ƒã«æˆ»ã™
                    saveText.textContent = 'è¨­å®šã‚’ä¿å­˜';
                    saveSpinner.classList.add('hidden');
                    saveButton.disabled = false;
                }, 2000);
            }
        }


        // ----------------------------------------------------
        // ãƒ¡ã‚¤ãƒ³å‡¦ç†ã®é–‹å§‹
        // ----------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
             // Firebaseã®åˆæœŸåŒ–ã¨èªè¨¼ã‚’é–‹å§‹
             initializeFirebase();
             
             // ãƒãƒƒã‚·ãƒ¥å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
             window.addEventListener('hashchange', renderPortal);
        });
        
    </script>
</body>
</html>
