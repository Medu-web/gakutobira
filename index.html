<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ãƒˆãƒ“ãƒ© - ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸç‰ˆ</title>
    <!-- Google Fonts: M PLUS Rounded 1c (UDé¢¨ã®ä¸¸ã‚´ã‚·ãƒƒã‚¯ä½“) ã‚’å°å…¥ -->
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK (Version 11.0.1) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // --- Firebase è¨­å®š (ã”æç¤ºã„ãŸã ã„ãŸå€¤ã‚’åæ˜ ) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCU6-hKFFa8dew_G_0_hDP8Q4eYqP0_7yU",
            authDomain: "gigaportal-editor.firebaseapp.com",
            projectId: "gigaportal-editor",
            storageBucket: "gigaportal-editor.firebasestorage.app",
            messagingSenderId: "969946487756",
            appId: "1:969946487756:web:fa4c4347d72de0b2dc9b69"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gigaportal-editor';

        let app, auth, db;
        let user = null;
        let portalData = {};
        let unsubscribeListener = null;

        const SCHOOL_PASSWORDS = { '01': 'portal01', '04': 'portal04', '07': 'portal07', '11': 'portal11' };
        const ADMIN_PASSWORD = 'admin123';
        
        // ãƒªãƒ³ã‚¯æƒ…å ±ã®ã¿ã«æˆ»ã™
        const defaultLinks = [
            { name: 'eãƒ©ã‚¤ãƒ–ãƒ©ãƒª', url: "https://ela.education.ne.jp/students/" },
            { name: 'ãƒ‰ãƒªãƒ«ãƒ—ãƒ©ãƒãƒƒãƒˆ', url: "https://login.kobun.co.jp/student-login/?code=1134304" },
            { name: 'NHK for School', url: "https://www.nhk.or.jp/school/" }
        ];

        function setStatus(msg) {
            console.log("Status:", msg);
            document.getElementById('main-title').textContent = msg; // IDå¤‰æ›´ã«ä¼´ã„ä¿®æ­£
        }

        const startApp = async () => {
            try {
                setStatus("Firebaseæ¥ç¶šä¸­...");
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (user) {
                        setStatus("èªè¨¼å®Œäº†ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...");
                        setupFirestoreListener();
                    }
                });

                // åŒ¿åèªè¨¼ã®å®Ÿè¡Œ
                await signInAnonymously(auth);
                
            } catch (error) {
                console.error("Firebase Init Error:", error);
                setStatus("âš ï¸ æ¥ç¶šã‚¨ãƒ©ãƒ¼: " + error.message);
            }
        };

        function setupFirestoreListener() {
            if (!user || !db) return;
            if (unsubscribeListener) unsubscribeListener();

            const rawHash = window.location.hash.substring(1).toLowerCase().replace(/\/+$/, '').trim() || 'default';
            const currentKey = resolveKey(rawHash);
            
            // ãƒ‘ã‚¹æ§‹é€ : artifacts/{appId}/public/data/portals/{currentKey} (å¶æ•°éšå±¤)
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'portals', currentKey);
            
            unsubscribeListener = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    portalData[currentKey] = docSnap.data();
                } else {
                    portalData[currentKey] = generateInitialData(currentKey);
                }
                renderPortal(currentKey);
            }, (error) => {
                console.error("Firestore Error:", error);
                portalData[currentKey] = generateInitialData(currentKey);
                renderPortal(currentKey);
                setStatus("âš ï¸ ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—ï¼ˆãƒ«ãƒ¼ãƒ«è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰");
            });
        }

        window.saveToCloud = async (key, newData) => {
            if (!user || !db) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'portals', key);
            await setDoc(docRef, newData);
        };

        function pad(num) { return num.toString().padStart(2, '0'); }
        const kanjiMap = { 1: 'ç¬¬ä¸€', 2: 'ç¬¬äºŒ', 3: 'ç¬¬ä¸‰', 4: 'ç¬¬å››', 5: 'ç¬¬äº”', 6: 'ç¬¬å…­', 7: 'ç¬¬ä¸ƒ', 8: 'ç¬¬å…«', 9: 'ç¬¬ä¹', 10: 'ç¬¬å', 11: 'ç¬¬åä¸€', 12: 'ç¬¬åäºŒ', 13: 'ç¬¬åä¸‰', 14: 'ç¬¬åå››', 15: 'ç¬¬åäº”', 16: 'ç¬¬åå…­', 17: 'ç¬¬åä¸ƒ', 18: 'ç¬¬åå…«', 19: 'ç¬¬åä¹', 20: 'ç¬¬äºŒå', 21: 'ç¬¬äºŒåä¸€' };

        function resolveKey(rawHash) {
            if (!rawHash || rawHash === 'default') return 'default';
            const matchXXgY = rawHash.match(/^(\d{1,2})g(\d{1})$/);
            if (matchXXgY) return `${pad(matchXXgY[1])}g${matchXXgY[2]}`;
            const matchXX = rawHash.match(/^(\d{1,2})$/);
            if (matchXX) return pad(matchXX[1]);
            return 'default';
        }

        function generateInitialData(key) {
            if (key === 'default') return { title: 'å…±é€šå­¦ç¿’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„', links: defaultLinks, infoHtml: 'å…±é€šãƒãƒ¼ã‚¿ãƒ«ã§ã™ã€‚' }; // ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ã€Œå­¦ãƒˆãƒ“ãƒ© - ã€ã‚’å‰Šé™¤
            const code = key.substring(0, 2);
            const num = parseInt(code, 10);
            const name = (kanjiMap[num] || code) + "å°å­¦æ ¡";
            if (key.includes('g')) {
                const grade = key.split('g')[1];
                return { title: `${name} ${grade}å¹´ç”Ÿ`, links: [...defaultLinks], infoHtml: `<p>${grade}å¹´ç”Ÿã®ãƒšãƒ¼ã‚¸ã§ã™ã€‚</p>` };
            }
            return { title: `${name} (å…¨å­¦å¹´å…±é€š)`, links: [...defaultLinks], infoHtml: `<p>${name}ã®å…±é€šãƒšãƒ¼ã‚¸ã§ã™ã€‚</p>` };
        }

        function renderPortal(key) {
            const data = portalData[key] || generateInitialData(key);
            
            // å¤‰æ›´ç‚¹ 1: H1ã¨H2ã‚’çµ±åˆã—ã€H1ã«ã€Œå­¦ãƒˆãƒ“ãƒ© - ã€ã‚’ä»˜ã‘ã¦è¨­å®šã™ã‚‹
            document.getElementById('main-title').textContent = `å­¦ãƒˆãƒ“ãƒ© - ${data.title}`;
            
            document.getElementById('info-section').innerHTML = data.infoHtml || '';
            
            const container = document.getElementById('link-container');
            container.innerHTML = '';
            (data.links || []).forEach(link => {
                const btn = document.createElement('a');
                btn.href = link.url;
                btn.className = 'link-button';
                
                // æ‰‰ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º
                const iconHtml = `<span class="door-icon"></span>`;
                
                btn.innerHTML = `${iconHtml}<span class="button-text">${link.name}</span>`;
                btn.onclick = handleLinkClick;
                container.appendChild(btn);
            });

            const rawHash = window.location.hash.substring(1);
            document.getElementById('emergency-section').classList.toggle('hidden', rawHash !== '');
            
            const urlParams = new URLSearchParams(window.location.search);
            document.getElementById('edit-button').classList.toggle('hidden', !urlParams.has('admin'));
        }

        function handleLinkClick(e) {
            if (this.href.includes('#')) return;
            e.preventDefault();
            const target = this.href;
            this.classList.add('opening');
            setTimeout(() => {
                window.open(target, '_blank');
                setTimeout(() => this.classList.remove('opening'), 100);
            }, 550);
        }

        window.handleEditClick = () => {
            const rawHash = window.location.hash.substring(1).toLowerCase() || 'default';
            const key = resolveKey(rawHash);
            const authCode = key.substring(0, 2);
            const required = (authCode === 'de') ? ADMIN_PASSWORD : (SCHOOL_PASSWORDS[authCode] || ADMIN_PASSWORD);

            const pw = prompt(`ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (#${key})`);
            if (pw === required) {
                showEditModal(key);
            } else if (pw !== null) {
                // alertã®ä»£ã‚ã‚Šã«ã‚«ã‚¹ã‚¿ãƒ UIã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ãŒã€æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã«åˆã‚ã›ã¾ã™
                alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚"); 
            }
        };

        function showEditModal(key) {
            const modal = document.getElementById('edit-modal');
            const editor = document.getElementById('json-editor');
            document.getElementById('modal-title').textContent = `ã‚¯ãƒ©ã‚¦ãƒ‰ç·¨é›†: #${key}`;
            editor.value = JSON.stringify(portalData[key] || generateInitialData(key), null, 2);
            modal.style.display = 'flex';
        }

        window.closeEditModal = () => document.getElementById('edit-modal').style.display = 'none';

        window.saveChanges = async () => {
            const editor = document.getElementById('json-editor');
            const rawHash = window.location.hash.substring(1).toLowerCase() || 'default';
            const key = resolveKey(rawHash);
            try {
                const newData = JSON.parse(editor.value);
                const saveBtn = document.querySelector('.modal-save');
                saveBtn.textContent = "ä¿å­˜ä¸­...";
                saveBtn.disabled = true;
                await window.saveToCloud(key, newData);
                closeEditModal();
                saveBtn.textContent = "ä¿å­˜ã—ã¦é©ç”¨";
                saveBtn.disabled = false;
            } catch (e) {
                // alertã®ä»£ã‚ã‚Šã«ã‚«ã‚¹ã‚¿ãƒ UIã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ãŒã€æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã«åˆã‚ã›ã¾ã™
                alert("ã‚¨ãƒ©ãƒ¼: JSONã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚\n" + e.message);
                document.querySelector('.modal-save').disabled = false;
                document.querySelector('.modal-save').textContent = "ä¿å­˜ã—ã¦é©ç”¨";
            }
        };

        window.addEventListener('hashchange', () => {
            setupFirestoreListener();
        });

        window.onload = startApp;
    </script>

    <style>
        /* CUDé©åˆé…è‰²: #004a99 (æ¿ƒã„é’)ã‚’ãƒ¡ã‚¤ãƒ³ã«ã€é«˜è¼åº¦å·®ã¨è‰²ã®åŒºåˆ¥æ€§ã‚’ç¢ºä¿ */
        body { 
            font-family: 'M PLUS Rounded 1c', sans-serif; 
            margin: 0; 
            padding: 10px; 
            background: #f9f9f9; /* ã‚ãšã‹ã«æ˜ã‚‹ã„ã‚ªãƒ•ãƒ›ãƒ¯ã‚¤ãƒˆ */
            text-align: center; 
            color: #333; 
            overflow-y: auto; 
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 15px; 
            background: #fff; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }
        
        /* ã‚¿ã‚¤ãƒˆãƒ«ã¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        h1 { 
            color: #004a99; /* æ¿ƒã„ç›®ã®ã‚¢ã‚«ãƒ‡ãƒŸãƒƒã‚¯ãƒ–ãƒ«ãƒ¼ */
            margin-bottom: 10px; 
            font-size: 2.0rem; 
        }
        .section-title { 
            color: #004a99; /* æ¿ƒã„ç›®ã®ã‚¢ã‚«ãƒ‡ãƒŸãƒƒã‚¯ãƒ–ãƒ«ãƒ¼ */
            /* H1ã®ä¸‹ç·šã¯ç¶­æŒã—ã€æœ€ã‚‚é‡è¦ãªåŒºåˆ‡ã‚Šã¨ã—ã¦å¼·èª¿ã™ã‚‹ */
            border-bottom: 3px solid #004a99; 
            padding-bottom: 5px; 
            margin-top: 20px; 
            min-height: 1.5em; 
        }

        .link-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 15px; 
            margin-top: 15px; 
        } 

        /* æ‰‰ã®å½¢çŠ¶ã¨ç«‹ä½“æ„Ÿã‚’å‡ºã™ã‚¹ã‚¿ã‚¤ãƒ« */
        .link-button { 
            display: flex; 
            flex-direction: column; 
            justify-content: center;
            align-items: center;
            height: 120px; 
            padding: 8px; 
            /* CUDèª¿æ•´: èƒŒæ™¯è‰²ã‚’æ˜ã‚‹ã„ãƒ©ãƒ™ãƒ³ãƒ€ãƒ¼ã‚°ãƒ¬ãƒ¼ã«ã€‚æ¿ƒã„æ–‡å­—ã¨ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå‘ä¸Š */
            background: #f8f8ff; 
            color: #004a99; /* æ¿ƒã„ç›®ã®ãƒ†ã‚­ã‚¹ãƒˆè‰² (æ–‡å­—ãŒä¸€ç•ªç›®ç«‹ã¤) */
            text-decoration: none; 
            
            /* ä¿®æ­£ç‚¹ï¼šæ ç·šã®è‰²ã‚’è–„ã„ã‚°ãƒ¬ãƒ¼ã«å¤‰æ›´ã—ã€H1ã‚¿ã‚¤ãƒˆãƒ«ä¸‹ç·šã¨ã®è¦–è¦šçš„ç«¶åˆã‚’é¿ã‘ã‚‹ */
            border: 3px solid #ccc; /* æ˜ã‚‹ã„ã‚°ãƒ¬ãƒ¼ã«å¤‰æ›´ */
            border-radius: 10px; 
            border-top-left-radius: 40px; 
            border-top-right-radius: 40px; 
            font-weight: bold; 
            font-size: 1.1rem; 
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); 
            transition: 0.3s ease; 
            position: relative; 
            overflow: hidden;
            text-shadow: none; 
        }

        .link-button:hover { 
            /* CUDèª¿æ•´: ãƒ›ãƒãƒ¼æ™‚ã«ã‚ãšã‹ã«æ¿ƒã„è‰²ï¼ˆè¼åº¦ã‚’ä¸‹ã’ã‚‹ï¼‰ */
            background: #e6e6ff; 
            transform: translateY(-3px); 
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.25);
        }

        /* æ‰‰ä¸­å¤®ã®ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆãƒãƒ–ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .door-icon { 
            width: 25px; 
            height: 30px; 
            background: linear-gradient(to top, #a0522d, #8B4513); 
            border: 2px solid #6b8e23; 
            border-radius: 6px 6px 0 0; 
            margin-bottom: 8px; 
            flex-shrink: 0; 
            transition: 0.5s ease; 
            transform-origin: center bottom; 
            position: relative;
            box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.4); 
        }
        
        /* æ‰‰ãŒé–‹ãã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸­å¤®ã‹ã‚‰å›è»¢ï¼‰ */
        .link-button.opening .door-icon { 
            transform: rotateY(-110deg) translateZ(10px); 
            opacity: 0;
        }
        
        /* ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸­å¤®ä¸‹éƒ¨ã«é…ç½® */
        .button-text { 
            flex-grow: 0; 
            text-align: center; 
            padding: 0 5px;
            font-size: 1em; 
        }

        /* ãã®ä»–ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .info-section { 
            margin-top: 20px; 
            padding: 15px; 
            background: #eeeeee; /* ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«ãªæ˜ã‚‹ã„ã‚°ãƒ¬ãƒ¼ */
            border-radius: 8px; 
            text-align: left; 
        }
        .hidden { display: none !important; }
        #edit-button { background: #3cb371; color: #fff; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-top: 10px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #fff; padding: 20px; border-radius: 10px; width: 90%; max-width: 700px; }
        textarea { width: 100%; height: 300px; font-family: monospace; margin: 10px 0; padding: 10px; box-sizing: border-box; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; }
        .modal-save { background: #004a99; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .modal-save:disabled { opacity: 0.5; cursor: not-allowed; }
        .modal-cancel { background: #ccc; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        
        /* CUDèª¿æ•´: ç·Šæ€¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .emergency-section { 
             margin-top: 20px; 
             padding: 15px; 
             border: 3px solid #b30000; /* æ¿ƒã„èµ¤ */
             background: #fff0f0; /* éå¸¸ã«æ˜ã‚‹ã„èµ¤ãƒ”ãƒ³ã‚¯ã§èƒŒæ™¯ã¨ã®è¼åº¦å·®ã‚’å¼·èª¿ */
             border-radius: 10px; 
        }
        .emergency-section h2 {
            color: #b30000; /* æ¿ƒã„èµ¤ */
        }
        .emergency-section .link-button {
            border-color: #b30000 !important;
            background: #ffebeb !important; /* ç·Šæ€¥ãƒœã‚¿ãƒ³ã®èƒŒæ™¯ã‚‚æ˜ã‚‹ã */
        }
        .emergency-section .link-button .door-icon {
            background: linear-gradient(to top, #660000, #993333) !important; 
            border-color: #b30000 !important;
        }
        .emergency-section .link-button .button-text {
            color: #b30000 !important;
        }

        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼ˆã•ã‚‰ã«è©°ã‚ã‚‹ï¼‰ */
        @media (max-width: 600px) {
            .container { padding: 10px; }
            .link-grid { gap: 10px; }
            .link-button { height: 100px; font-size: 1rem; }
            .door-icon { height: 25px; width: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤‰æ›´ç‚¹ 1: H1ã¨H2ã‚’çµ±åˆã—ã€H1ã®ã¿ã§è¡¨ç¤º -->
        <h1 id="main-title" class="section-title">âŒ› åˆæœŸåŒ–ä¸­...</h1>
        <button id="edit-button" class="hidden" onclick="handleEditClick()">ãƒãƒ¼ã‚¿ãƒ«ã‚’ç·¨é›†</button>

        <div class="link-grid" id="link-container"></div>
        <div class="info-section" id="info-section"></div>

        <div class="emergency-section hidden" id="emergency-section">
            <h2>ğŸš¨ ç·Šæ€¥å¯¾å¿œã®æ‰‰</h2>
            <div class="link-grid">
                <a href="https://portal.office.com/" class="link-button" target="_blank">
                    <!-- ç·Šæ€¥ãƒœã‚¿ãƒ³ã¯æ¿ƒã„èµ¤ã§ç›®ç«‹ãŸã›ã‚‹ -->
                    <span class="door-icon"></span>
                    <span class="button-text">Microsoft 365 Portal</span>
                </a>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title">ãƒãƒ¼ã‚¿ãƒ«ç·¨é›†</h3>
            <textarea id="json-editor"></textarea>
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="modal-save" onclick="saveChanges()">ä¿å­˜ã—ã¦é©ç”¨</button>
            </div>
        </div>
    </div>
</body>
</html>
