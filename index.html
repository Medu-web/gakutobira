<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ãƒˆãƒ“ãƒ©</title>
    <!-- Tailwind CSS ã¯ä½¿ç”¨ã—ã¦ã„ã¾ã›ã‚“ãŒã€ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªåŸºæœ¬ãƒ‡ã‚¶ã‚¤ãƒ³ã¯CSSã§å®Ÿç¾ã—ã¦ã„ã¾ã™ -->
    <style>
        /* ------------------------------------- */
        /* å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        /* ------------------------------------- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            text-align: center;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }

        h1 {
            color: #0056b3;
            margin-bottom: 5px;
            font-size: 2.2em;
            padding-top: 10px;
        }

        .subtitle {
            color: #555;
            margin-bottom: 25px;
            font-size: 1.1em;
            font-weight: bold;
        }

        /* ------------------------------------- */
        /* ãƒœã‚¿ãƒ³ã¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        /* ------------------------------------- */
        .section-title {
            color: #0056b3;
            border-bottom: 3px solid #0056b3;
            padding-bottom: 5px;
            margin-top: 30px;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .link-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .link-button {
            display: flex;
            align-items: center;
            justify-content: flex-start; /* å·¦å¯„ã› */
            padding: 20px 15px;
            background-color: #e9f0f8;
            color: #0056b3;
            text-decoration: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            min-height: 80px;
            text-align: left;
            line-height: 1.3;
            perspective: 1000px;
        }

        .link-button:hover {
            background-color: #d0e0f0;
            transform: translateY(-2px);
        }

        /* ------------------------------------- */
        /* ãƒ‰ã‚¢ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        /* ------------------------------------- */
        .door-icon {
            position: relative;
            width: 24px;
            height: 32px;
            background-color: #a0522d;
            border: 2px solid #8B4513;
            border-radius: 4px 4px 0 0;
            margin-right: 15px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
            transform-origin: left center;
            transition: transform 0.5s ease-out, opacity 0.5s ease-out; 
            transform: rotateY(0deg);
        }
        
        .link-button.opening .door-icon {
            transform: rotateY(-110deg);
            opacity: 0;
        }

        .door-icon::after {
            content: '';
            position: absolute;
            top: 10px;
            right: 5px;
            width: 4px;
            height: 4px;
            background-color: #ffd700;
            border-radius: 50%;
        }

        .button-text {
            flex-grow: 1;
            text-align: left; /* å·¦å¯„ã›ã«æˆ»ã™ */
        }

        /* ------------------------------------- */
        /* ç·Šæ€¥å¯¾å¿œã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å¼·èª¿ */
        /* ------------------------------------- */
        .emergency-section {
            margin-top: 40px;
            padding: 20px;
            border: 4px solid #cc0000;
            background-color: #ffe6e6;
            border-radius: 12px;
        }

        .emergency-section .section-title {
            color: #cc0000;
            border-bottom: 3px solid #cc0000;
        }
        
        .emergency-description {
            color: #cc0000;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .emergency-button {
            background-color: #ff9900;
            color: #333;
            border: 3px solid #cc7a00;
            font-size: 1.2em;
            padding: 25px 15px;
            justify-content: center; /* ã‚»ãƒ³ã‚¿ãƒ¼ã«æˆ»ã™ */
            text-align: center;
        }

        .emergency-button:hover {
            background-color: #ffc04d;
            color: #000;
        }
        
        .emergency-button .door-icon {
            background-color: #cc3333; 
            border-color: #a00000;
        }

        /* ------------------------------------- */
        /* ãƒ•ãƒƒã‚¿ãƒ¼ã¨ãƒ­ãƒ¼ãƒ‰çŠ¶æ…‹ */
        /* ------------------------------------- */
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            font-size: 0.9em;
            color: #777;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            font-size: 1.2em;
            color: #0056b3;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0056b3;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ (ãƒ¢ãƒã‚¤ãƒ«å‘ã‘) */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
            }
            .link-button, .emergency-button {
                min-height: 60px;
                font-size: 1em;
            }
            .door-icon {
                margin-right: 10px;
                width: 20px;
                height: 28px;
            }
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <span>ãƒãƒ¼ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...</span>
        <span id="auth-status" class="text-sm mt-3 text-gray-600">èªè¨¼å¾…æ©Ÿä¸­...</span>
    </div>
    
    <div class="container hidden" id="main-content">
        <h1><ruby>å­¦<rt>ã‚¬ã‚¯</rt></ruby>ãƒˆãƒ“ãƒ©</h1>
        <p class="subtitle">ã•ã‚ã€å­¦ç¿’ã®æ‰‰ã‚’é–‹ã“ã†ï¼ (ãƒãƒ¼ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯Firebaseã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™)</p>

        <!-- ------------------------------------- -->
        <!-- å­¦ç¿’Webã‚¢ãƒ—ãƒªã‚»ã‚¯ã‚·ãƒ§ãƒ³ (ãƒ¡ã‚¤ãƒ³) -->
        <!-- ------------------------------------- -->
        <h2 class="section-title" id="main-section-title">ğŸ“— å­¦ç¿’ã®æ‰‰</h2>
        
        <div class="link-grid" id="link-container">
            <!-- å‹•çš„ã«ãƒªãƒ³ã‚¯ãŒæŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </div>

        <!-- ------------------------------------- -->
        <!-- ç·Šæ€¥å¯¾å¿œã‚»ã‚¯ã‚·ãƒ§ãƒ³ (ãƒˆãƒ©ãƒ–ãƒ«å›é¿) -->
        <!-- ------------------------------------- -->
        <div class="emergency-section">
            <h2 class="section-title">ğŸš¨ ç·Šæ€¥å¯¾å¿œã®æ‰‰ï¼šã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚„ãƒ‡ãƒ¼ã‚¿æ¶ˆå¤±ã®ãƒˆãƒ©ãƒ–ãƒ«æ™‚</h2>
            <p class="emergency-description">
                **ã€é‡è¦ã€‘** OneDriveãƒ•ã‚©ãƒ«ãƒ€ã‚„ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚¢ãƒ—ãƒª(Teams/Office)ã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã§ããªã„å ´åˆã¯ã€**å¿…ãšã“ã®ãƒªãƒ³ã‚¯**ã‹ã‚‰Webãƒ–ãƒ©ã‚¦ã‚¶ç‰ˆã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚
            </p>
            
            <div class="link-grid">
                <a href="https://portal.office.com/" class="link-button emergency-button">
                    <span class="door-icon"></span><span class="button-text">Microsoftã®ã‚¹ã‚¿ãƒ¼ãƒˆãƒšãƒ¼ã‚¸<br>(Webç‰ˆ Office, Teams, OneDriveã¯ã“ã¡ã‚‰)</span>
                </a>

                <a href="https://placehold.co/100x100?text=Manual_PDF" class="link-button emergency-button">
                    <span class="door-icon"></span><span class="button-text">ã‚µã‚¤ãƒ³ã‚¤ãƒ³å¾©æ—§æ‰‹é †æ›¸<br>ï¼ˆãƒˆãƒ©ãƒ–ãƒ«è§£æ±ºãƒãƒ‹ãƒ¥ã‚¢ãƒ«ï¼‰</span>
                </a>
            </div>
        </div>

        <!-- ------------------------------------- -->
        <!-- ãƒ•ãƒƒã‚¿ãƒ¼æƒ…å ± -->
        <!-- ------------------------------------- -->
        <div class="footer">
            <p>Portal Key: <span id="portal-key-display">default</span> | User ID: <span id="user-id-display">N/A</span></p>
        </div>
    </div>

    <!-- Firebase SDKã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let unsubscribe = null;

        // Canvasç’°å¢ƒå¤‰æ•°
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // UIè¦ç´ 
        const loadingOverlay = document.getElementById('loading-overlay');
        const mainContent = document.getElementById('main-content');
        const authStatusElement = document.getElementById('auth-status');
        const userIdDisplayElement = document.getElementById('user-id-display');
        const portalKeyDisplayElement = document.getElementById('portal-key-display');
        
        // ------------------------------------------
        // åˆæœŸãƒ‡ãƒ¼ã‚¿ï¼ˆFirestoreã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã«ä½¿ç”¨ï¼‰
        // ------------------------------------------
        const initialPortalData = {
            // ----------------------------------------------------
            // å…±é€šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š (ãƒãƒƒã‚·ãƒ¥ãŒãªã„å ´åˆ)
            'default': {
                title: 'ğŸ’¡ å…±é€šå­¦ç¿’ã®æ‰‰',
                links: [
                    { name: "eãƒ©ã‚¤ãƒ–ãƒ©ãƒª", url: "https://ela.education.ne.jp/students/" },
                    { name: "ãƒ‰ãƒªãƒ«ãƒ—ãƒ©ãƒãƒƒãƒˆ", url: "https://login.kobun.co.jp/student-login/?code=1134304" },
                    { name: "ã‚­ãƒ¼ãƒœãƒ¼å³¶ (ã‚¿ã‚¤ãƒ”ãƒ³ã‚°)", url: "https://kb-kentei.net/" },
                    { name: "å­¦æ ¡å…¨ä½“å…±é€šã®Webã‚µã‚¤ãƒˆ", url: "https://placehold.co/100x100?text=School_Web" },
                ]
            },
            
            // ----------------------------------------------------
            // å­¦æ ¡ã‚³ãƒ¼ãƒ‰ 001 (ä¾‹: ã€‡ã€‡å¸‚ç«‹ä¸­å¤®å°å­¦æ ¡) å‘ã‘è¨­å®š
            // ----------------------------------------------------
            's_001_all': {
                title: 'ğŸ« ä¸­å¤®å°å­¦æ ¡ å…¨æ ¡å…±é€šã®æ‰‰',
                links: [
                    { name: "eãƒ©ã‚¤ãƒ–ãƒ©ãƒª", url: "https://ela.education.ne.jp/students/" },
                    { name: "å­¦æ ¡é€£çµ¡äº‹é … (æ²ç¤ºæ¿)", url: "https://placehold.co/100x100?text=Info" },
                    { name: "å…ˆç”Ÿã¸ã®è³ªå•ãƒ•ã‚©ãƒ¼ãƒ ", url: "https://placehold.co/100x100?text=Q_Form" },
                    { name: "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°æ•™æ (Scratch)", url: "https://placehold.co/100x100?text=Scratch" },
                ]
            },
            
            // å­¦æ ¡ 001 ã® 5å¹´ç”Ÿ (g5) å‘ã‘
            's_001_g5_all': {
                title: 'âœï¸ ä¸­å¤®å°å­¦æ ¡ 5å¹´ç”Ÿ å­¦å¹´ã®æ‰‰',
                links: [
                    { name: "5å¹´ ç®—æ•°ãƒ‰ãƒªãƒ«", url: "https://placehold.co/100x100?text=Math_D" },
                    { name: "5å¹´ ç†ç§‘ã®è¦³å¯Ÿè¨˜éŒ²", url: "https://placehold.co/100x100?text=Science_R" },
                    { name: "ç¤¾ä¼šç§‘è¦‹å­¦Webã‚µã‚¤ãƒˆ", url: "https://placehold.co/100x100?text=Study_Tour" },
                    { name: "5å¹´ å­¦å¹´å…±é€š èª²é¡Œæå‡º", url: "https://placehold.co/100x100?text=Assignment_5G" },
                ]
            },
        };

        // ------------------------------------------
        // Firestoreãƒ‘ã‚¹ã¨ã‚­ãƒ¼ã®å‡¦ç†
        // ------------------------------------------

        /**
         * URLãƒãƒƒã‚·ãƒ¥ã‚’Firestoreã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã«å¤‰æ›
         * #s/001/g5/all -> s_001_g5_all
         */
        function getDocIdFromHash(hash) {
            if (!hash) return 'default';
            // ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã«å¤‰æ›
            return hash.replace(/\//g, '_').toLowerCase();
        }

        /**
         * Firestoreã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§ã‚’å–å¾— (å…¬é–‹ãƒ‡ãƒ¼ã‚¿)
         */
        function getPortalDocRef(docId) {
            // Firestore Path: /artifacts/{appId}/public/data/portals/{docId}
            return doc(db, 'artifacts', appId, 'public', 'data', 'portals', docId);
        }

        // ------------------------------------------
        // FirebaseåˆæœŸåŒ–ã¨èªè¨¼
        // ------------------------------------------

        async function initializeFirebase() {
            setLogLevel('debug');
            
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // èªè¨¼å‡¦ç†ã‚’é–‹å§‹
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // èªè¨¼çŠ¶æ…‹ã®å¤‰æ›´ã‚’ç›£è¦–ã—ã€userIdã‚’è¨­å®š
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        userIdDisplayElement.textContent = `${userId.substring(0, 8)}...`;
                        authStatusElement.textContent = 'èªè¨¼å®Œäº†ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ã¾ã™...';
                        console.log("AuthçŠ¶æ…‹ç¢ºå®š: userId =", userId);
                        
                        // èªè¨¼å®Œäº†å¾Œã€ãƒãƒ¼ã‚¿ãƒ«ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’é–‹å§‹
                        loadPortalData();
                    } else {
                        // èªè¨¼å¤±æ•—ã¾ãŸã¯ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆï¼ˆåŒ¿åèªè¨¼ãŒæˆåŠŸã—ã¦ã„ã‚‹ã¯ãšã ãŒå¿µã®ãŸã‚ï¼‰
                        userId = 'anonymous';
                        isAuthReady = true;
                        userIdDisplayElement.textContent = userId;
                        authStatusElement.textContent = 'åŒ¿åèªè¨¼å¤±æ•—ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚';
                        console.error("AuthçŠ¶æ…‹æœªç¢ºå®šã€‚ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚");
                        
                        // ã‚¨ãƒ©ãƒ¼æ™‚ã§ã‚‚UIãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’è©¦ã¿ã‚‹
                        renderPortalUI(initialPortalData['default'], 'default');
                        loadingOverlay.classList.add('hidden');
                        mainContent.classList.remove('hidden');
                    }
                });
                
            } catch (error) {
                console.error("FirebaseåˆæœŸåŒ–/èªè¨¼ã‚¨ãƒ©ãƒ¼:", error);
                authStatusElement.textContent = `åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                // è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã§è¡¨ç¤º
                renderPortalUI(initialPortalData['default'], 'default');
                loadingOverlay.classList.add('hidden');
                mainContent.classList.remove('hidden');
            }
        }

        // ------------------------------------------
        // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ã¨ãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        // ------------------------------------------

        function loadPortalData() {
            if (!isAuthReady) {
                console.log("èªè¨¼å®Œäº†ã‚’å¾…æ©Ÿä¸­...");
                return;
            }

            // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ãŒã‚ã‚Œã°è§£é™¤
            if (unsubscribe) {
                unsubscribe();
            }

            const currentHash = window.location.hash.substring(1);
            const docId = getDocIdFromHash(currentHash);
            const docRef = getPortalDocRef(docId);
            
            portalKeyDisplayElement.textContent = docId;

            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            unsubscribe = onSnapshot(docRef, async (docSnap) => {
                let data;
                let currentKey = docId;

                if (docSnap.exists()) {
                    // 1. ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
                    data = docSnap.data();
                    authStatusElement.textContent = `ãƒ‡ãƒ¼ã‚¿å—ä¿¡: #${docId}`;
                } else {
                    // 2. ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆ
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯: åˆæœŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚­ãƒ¼ã‚’æ¢ã™
                    data = initialPortalData[docId];

                    if (!data) {
                        // æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼š'default'ã‚’ä½¿ç”¨
                        data = initialPortalData['default'];
                        currentKey = 'default';
                        authStatusElement.textContent = `ãƒ‡ãƒ¼ã‚¿ãªã—ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’é©ç”¨ã€‚`;
                    } else {
                        // è¦‹ã¤ã‹ã£ãŸåˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã«ã‚·ãƒ¼ãƒ‰ï¼ˆæ›¸ãè¾¼ã¿ï¼‰
                        await setDoc(docRef, data).catch(e => console.error("åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒ‰å¤±æ•— (æ¨©é™ç¢ºèª):", e));
                        authStatusElement.textContent = `åˆæœŸãƒ‡ãƒ¼ã‚¿è¨­å®š: #${docId}`;
                    }
                }
                
                // UIã‚’æ›´æ–°
                renderPortalUI(data, currentKey);
                loadingOverlay.classList.add('hidden');
                mainContent.classList.remove('hidden');

            }, (error) => {
                // Firestore onSnapshot ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° (æ¨©é™ã‚¨ãƒ©ãƒ¼ä¿®æ­£ã®æ ¸å¿ƒ)
                console.error("Firestore onSnapshot ã‚¨ãƒ©ãƒ¼:", error);
                
                // ã‚¨ãƒ©ãƒ¼æ™‚ã§ã‚‚UIã‚’æ›´æ–°ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æƒ…å ±ã‚’æä¾›ã™ã‚‹
                const fallbackData = initialPortalData['default'];
                renderPortalUI(fallbackData, 'default (ã‚¨ãƒ©ãƒ¼æ™‚)');
                
                authStatusElement.textContent = `ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message.split('.')[0]}`;
                loadingOverlay.classList.add('hidden');
                mainContent.classList.remove('hidden');
            });
        }
        
        // ------------------------------------------
        // UIãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        // ------------------------------------------

        function renderPortalUI(data, currentKey) {
            const container = document.getElementById('link-container');
            const titleElement = document.getElementById('main-section-title');

            // ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
            titleElement.innerHTML = `${data.title} <span style="font-size: 0.8em; color: #888; display: block; margin-top: 5px;">(Key: ${currentKey})</span>`;
            
            container.innerHTML = ''; // æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢

            // ãƒªãƒ³ã‚¯ã‚’å‹•çš„ã«ç”Ÿæˆ
            if (data.links && Array.isArray(data.links)) {
                data.links.forEach(link => {
                    const linkElement = document.createElement('a');
                    linkElement.href = link.url;
                    linkElement.className = 'link-button';
                    
                    linkElement.innerHTML = `<span class="door-icon"></span><span class="button-text">${link.name}</span>`;
                    container.appendChild(linkElement);
                });
            }
            
            // å‹•çš„ã«ç”Ÿæˆã•ã‚ŒãŸãƒªãƒ³ã‚¯ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            attachAnimationListeners();
        }

        // ------------------------------------------
        // UIã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        // ------------------------------------------
        const animationDuration = 500;
        
        function handleLinkClick(e) {
            const targetUrl = this.href;
            
            // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼ˆ#ã¾ãŸã¯placehold.coï¼‰ã®å ´åˆã¯é·ç§»ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            if (targetUrl.endsWith('#') || targetUrl.includes('placehold.co')) {
                 e.preventDefault();
                 return;
            }

            e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒªãƒ³ã‚¯é·ç§»ã‚’åœæ­¢
            this.classList.add('opening');

            setTimeout(() => {
                window.open(targetUrl, '_blank');
                
                setTimeout(() => {
                     this.classList.remove('opening');
                }, 100);

            }, animationDuration + 50); 
        }

        function attachAnimationListeners() {
            const linkButtons = document.querySelectorAll('.link-button');
            linkButtons.forEach(button => {
                button.removeEventListener('click', handleLinkClick); 
                button.addEventListener('click', handleLinkClick);
            });
        }

        // ------------------------------------------
        // åˆæœŸå®Ÿè¡Œã¨ãƒãƒƒã‚·ãƒ¥å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
        // ------------------------------------------
        document.addEventListener('DOMContentLoaded', initializeFirebase);
        
        // ãƒãƒƒã‚·ãƒ¥å¤‰æ›´æ™‚ã‚‚ãƒãƒ¼ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å†ãƒ­ãƒ¼ãƒ‰
        window.addEventListener('hashchange', loadPortalData); 
    </script>
</body>
</html>
