<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ãƒˆãƒ“ãƒ©</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ------------------------------------- */
        /* å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        /* ------------------------------------- */
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f4f8; /* ãƒ©ã‚¤ãƒˆãƒ–ãƒ«ãƒ¼ã®èƒŒæ™¯ */
            color: #1e293b;
            text-align: center;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px 20px;
            background-color: #ffffff;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border-radius: 16px;
        }

        h1 {
            color: #007bff; /* ä¸»è¦ãªé’ */
            margin-bottom: 5px;
            font-size: 2.2em;
            padding-top: 10px;
            font-weight: 800;
        }

        .subtitle {
            color: #64748b;
            margin-bottom: 30px;
            font-size: 1.1em;
            font-weight: 500;
        }

        /* ------------------------------------- */
        /* ãƒœã‚¿ãƒ³ã¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        /* ------------------------------------- */
        .link-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .link-button {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 15px 25px;
            background-color: #e0f2fe; /* æ·¡ã„é’ */
            color: #007bff;
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 2px solid transparent;
            text-align: left;
        }

        .link-button:hover {
            background-color: #007bff;
            color: #ffffff;
            box-shadow: 0 8px 15px rgba(0, 123, 255, 0.3);
            transform: translateY(-3px);
            border-color: #0056b3;
        }

        .link-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .door-icon {
            font-size: 1.5em;
            margin-right: 15px;
            transition: transform 0.2s;
            /* SVGã‚„ç”»åƒã‚’ä½¿ç”¨ã—ãªã„ãŸã‚ã€ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªè¨˜å·ã‚„ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½¿ç”¨ */
        }
        
        .door-icon::before {
            content: "ğŸšª"; /* ãƒ‰ã‚¢ã®çµµæ–‡å­— */
        }

        .link-button:hover .door-icon {
            transform: rotate(5deg) scale(1.1);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            font-size: 1.2em;
            color: #007bff;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <span>ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...</span>
        <span id="auth-status" class="text-sm mt-3 text-gray-600">èªè¨¼å¾…æ©Ÿä¸­...</span>
    </div>
    
    <div class="container hidden" id="main-content">
        <h1 class="text-gray-900">å­¦ãƒˆãƒ“ãƒ©</h1>
        <p class="subtitle">å­¦æ ¡ãƒ»å­¦åœ’ã”ã¨ã®ãƒãƒ¼ã‚¿ãƒ«ãƒªãƒ³ã‚¯é›†</p>

        <h2 id="main-section-title" class="text-xl font-bold text-gray-700 mb-6 border-b pb-2"></h2>
        
        <div class="link-container" id="link-container">
            <!-- ãƒªãƒ³ã‚¯ãŒã“ã“ã«å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </div>

        <div id="user-info" class="mt-8 text-sm text-gray-500">
            <p>ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID (Firestore Private Path Key): <span id="display-user-id" class="font-mono text-xs bg-gray-100 p-1 rounded"></span></p>
        </div>
    </div>

    <!-- Firebase SDKã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
    <script type="module">
        // Firebaseã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // Canvasç’°å¢ƒå¤‰æ•°
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆ
        let portalData = null; // Firestoreã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ

        const loadingOverlay = document.getElementById('loading-overlay');
        const mainContent = document.getElementById('main-content');
        const authStatusElement = document.getElementById('auth-status');
        const displayUserIdElement = document.getElementById('display-user-id');

        // ------------------------------------------
        // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        // ------------------------------------------

        /**
         * åˆæœŸãƒ‡ãƒ¼ã‚¿ã¾ãŸã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
         * @returns {Object} ãƒãƒ¼ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ã®æ§‹é€ 
         */
        function createDefaultPortalData() {
            return {
                'default': {
                    title: 'ã‚ˆã†ã“ãï¼ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ã‚¿ãƒ«',
                    links: [
                        { name: 'è¨­å®šã¨ãƒ˜ãƒ«ãƒ—', url: 'https://www.google.com/search?q=help+and+settings' },
                        { name: 'ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é€ä¿¡', url: 'https://www.google.com/search?q=send+feedback' }
                    ]
                },
                'A': {
                    title: 'å­¦åœ’A ãƒªãƒ³ã‚¯ãƒãƒ¼ã‚¿ãƒ« (ãƒ‡ãƒ¢)',
                    links: [
                        { name: 'A-1: æˆæ¥­ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«', url: 'https://placehold.co/100x100?text=A1' },
                        { name: 'A-2: æˆç¸¾ç¢ºèªã‚·ã‚¹ãƒ†ãƒ ', url: 'https://placehold.co/100x100?text=A2' }
                    ]
                },
                'B': {
                    title: 'å­¦åœ’B ãƒªãƒ³ã‚¯ãƒãƒ¼ã‚¿ãƒ« (ãƒ‡ãƒ¢)',
                    links: [
                        { name: 'B-1: å›³æ›¸é¤¨æ¤œç´¢', url: 'https://placehold.co/100x100?text=B1' },
                        { name: 'B-2: ã‚¯ãƒ©ãƒ–æ´»å‹•æƒ…å ±', url: 'https://placehold.co/100x100?text=B2' }
                    ]
                }
            };
        }

        /**
         * ç¾åœ¨ã®URLãƒãƒƒã‚·ãƒ¥ã¨ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦UIã‚’æ›´æ–°ã—ã¾ã™ã€‚
         */
        function updateUIFromLocalData() {
            if (!portalData) {
                console.warn("portalDataãŒã¾ã ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚");
                portalData = createDefaultPortalData();
            }

            let currentHash = window.location.hash.substring(1).toUpperCase();
            let currentKey = currentHash || 'default';

            let data = portalData[currentKey];

            // ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯
            if (!data) {
                // ãƒãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã®æœ€åˆã®æ–‡å­—ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                let schoolFallbackKey = currentHash.length > 0 ? currentHash.charAt(0) : '';
                if (schoolFallbackKey && portalData[schoolFallbackKey]) {
                    currentKey = schoolFallbackKey;
                    data = portalData[schoolFallbackKey];
                }
            }

            // æœ€çµ‚çš„ã«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°'default'ã‚’ä½¿ç”¨
            if (!data) {
                currentKey = 'default';
                data = portalData[currentKey];
            }


            const container = document.getElementById('link-container');
            const titleElement = document.getElementById('main-section-title');

            // ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
            titleElement.innerHTML = `${data.title} <span style="font-size: 0.8em; color: #888; display: block; margin-top: 5px;">(URL Key: #${currentKey})</span>`;
            
            // æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢
            container.innerHTML = '';

            // ãƒªãƒ³ã‚¯ã‚’å‹•çš„ã«ç”Ÿæˆ
            data.links.forEach(link => {
                const linkElement = document.createElement('a');
                linkElement.href = link.url;
                linkElement.className = 'link-button';
                
                // HTMLæ§‹é€ ã‚’æ§‹ç¯‰
                linkElement.innerHTML = `<span class="door-icon"></span><span class="button-text">${link.name}</span>`;
                container.appendChild(linkElement);
            });
            
            // UIã®è¡¨ç¤º
            loadingOverlay.classList.add('hidden');
            mainContent.classList.remove('hidden');

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®è¡¨ç¤º
            displayUserIdElement.textContent = userId || 'æœªèªè¨¼/èªè¨¼ã‚¨ãƒ©ãƒ¼';
        }

        // ------------------------------------------
        // FirebaseåˆæœŸåŒ–ã¨èªè¨¼ (æ¨©é™ã‚¨ãƒ©ãƒ¼ã®ä¿®æ­£ç®‡æ‰€)
        // ------------------------------------------

        /**
         * Firestoreã®onSnapshotãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚
         * ã“ã‚Œã¯èªè¨¼ãŒå®Œäº†ã—ãŸå¾Œã«ã®ã¿å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚
         */
        function setupDataListener() {
            if (!db || !userId) {
                console.error("Firestoreã¾ãŸã¯userIdãŒãƒªã‚¹ãƒŠãƒ¼è¨­å®šã«æœªæº–å‚™ã§ã™ã€‚");
                return;
            }

            // ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ç”¨ã®æ­£ã—ã„Firestoreãƒ‘ã‚¹
            // /artifacts/{appId}/users/{userId}/portal_data/links
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/portal_data/links`); 
            console.log("Firestore onSnapshotãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šä¸­ã€‚ãƒ‘ã‚¹:", docRef.path);

            // 1. ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã«åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ¼ãƒ‰ (ã‚»ãƒƒãƒˆ) 
            getDoc(docRef).then(docSnap => {
                if (!docSnap.exists()) {
                    console.log("ãƒ‡ãƒ¼ã‚¿ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¾ã™ã€‚");
                    setDoc(docRef, createDefaultPortalData()).catch(e => console.error("åˆæœŸãƒ‡ãƒ¼ã‚¿è¨­å®šã‚¨ãƒ©ãƒ¼:", e));
                }
            }).catch(e => console.error("ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå­˜åœ¨ç¢ºèªã‚¨ãƒ©ãƒ¼:", e));


            // 2. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ (onSnapshot) ã‚’è¨­å®š
            // ã“ã‚ŒãŒæ¨©é™ã‚¨ãƒ©ãƒ¼ã®ä¸»ãªåŸå› ã ã£ãŸãŸã‚ã€èªè¨¼å¾Œã«å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ä¿®æ­£
            onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    console.log("Firestoreã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã—ã¾ã—ãŸã€‚");
                    // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«æ ¼ç´
                    portalData = doc.data();
                } else {
                    console.warn("ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Firestoreã«ãƒãƒ¼ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚");
                    portalData = createDefaultPortalData();
                }
                updateUIFromLocalData(); // ãƒ‡ãƒ¼ã‚¿å¤‰æ›´æ™‚ã«UIã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            }, (error) => {
                // onSnapshotã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©: ã“ã“ã§æ¨©é™ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ
                console.error("Firestore onSnapshot ã‚¨ãƒ©ãƒ¼ (ä¿®æ­£æ¸ˆã¿):", error);
                authStatusElement.textContent = `èªè¨¼æ¸ˆã¿ (ã‚¨ãƒ©ãƒ¼: ${error.code})`;
                // æ°¸ç¶šçš„ãªã‚¨ãƒ©ãƒ¼ã®å ´åˆã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                portalData = createDefaultPortalData(); 
                updateUIFromLocalData();
            });
        }

        /**
         * Firebaseã®åˆæœŸåŒ–ã¨èªè¨¼ã‚’è¡Œã„ã€ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’é–‹å§‹ã—ã¾ã™ã€‚
         */
        async function setupFirebaseAndFetchData() {
            console.log("Firebaseã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–‹å§‹...");
            authStatusElement.textContent = 'èªè¨¼å‡¦ç†ä¸­...';
            
            try {
                setLogLevel('debug'); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æœ‰åŠ¹åŒ–
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // èªè¨¼å‡¦ç†
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚");
                } else {
                    await signInAnonymously(auth);
                    console.log("åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚");
                }
                
                authStatusElement.textContent = 'èªè¨¼å®Œäº†ã€‚ãƒ‡ãƒ¼ã‚¿å–å¾—å¾…æ©Ÿä¸­...';
                
                // onAuthStateChangedã§ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—ã—ã€ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                // ã“ã®ãƒªã‚¹ãƒŠãƒ¼ãŒFireStoreæ“ä½œã®å‰ã«ç¢ºå®Ÿã«èªè¨¼çŠ¶æ…‹ã‚’ç¢ºå®šã•ã›ã¾ã™ã€‚
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("AuthçŠ¶æ…‹ãŒç¢ºå®šã—ã¾ã—ãŸã€‚userId:", userId);
                        authStatusElement.textContent = `èªè¨¼æ¸ˆã¿ (UID: ${userId.substring(0, 8)}...)`;
                        // èªè¨¼ãŒå®Œäº†ã—ãŸå¾Œã«ã®ã¿ã€Firestoreã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š (æ¨©é™ã‚¨ãƒ©ãƒ¼ä¿®æ­£ã®æ ¸å¿ƒ)
                        setupDataListener();
                    } else {
                        // èªè¨¼å¤±æ•—æ™‚ã¾ãŸã¯ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆæ™‚
                        console.error("èªè¨¼çŠ¶æ…‹ãŒè§£æ±ºã—ã¾ã›ã‚“ã§ã—ãŸã€‚");
                        userId = crypto.randomUUID(); // Fallback ID
                        isAuthReady = true;
                        authStatusElement.textContent = `æœªèªè¨¼ (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ID)`;
                        // èªè¨¼ãŒä¸è¦ãªå…¬é–‹ãƒ‡ãƒ¼ã‚¿ã®å ´åˆã¯ã“ã“ã§ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã§ãã¾ã™ãŒã€ä»Šå›ã¯ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ‘ã‚¹ã®ãŸã‚ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã™ã€‚
                        // ãƒ‡ãƒ¼ã‚¿å–å¾—ã¯setupDataListenerå†…ã§å‡¦ç†ã•ã‚Œã¾ã™ã€‚
                    }
                    unsubscribe(); // çŠ¶æ…‹å¤‰æ›´ã®æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆå¾Œã«ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã‚’åœæ­¢
                });
                
            } catch (error) {
                console.error("FirebaseåˆæœŸåŒ–/èªè¨¼ã‚¨ãƒ©ãƒ¼:", error);
                authStatusElement.textContent = `åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                // é‡å¤§ãªã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã§UIã‚’æ›´æ–°
                portalData = createDefaultPortalData();
                updateUIFromLocalData();
            }
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã¨ãƒãƒƒã‚·ãƒ¥å¤‰æ›´æ™‚ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        document.addEventListener('DOMContentLoaded', setupFirebaseAndFetchData);
        window.addEventListener('hashchange', updateUIFromLocalData); 
    </script>
</body>
</html>
