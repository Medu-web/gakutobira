<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ãƒˆãƒ“ãƒ© - æ­¦è”µæ‘å±±ç‰ˆ</title>
    <!-- Google Fonts: M PLUS Rounded 1c -->
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK (Version 11.0.1) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCU6-hKFFa8dew_G_0_hDP8Q4eYqP0_7yU",
            authDomain: "gigaportal-editor.firebaseapp.com",
            projectId: "gigaportal-editor",
            storageBucket: "gigaportal-editor.firebasestorage.app",
            messagingSenderId: "969946487756",
            appId: "1:969946487756:web:fa4c4347d72de0b2dc9b69"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gigaportal-editor';

        let app, auth, db;
        let user = null;
        let portalData = {};
        let unsubscribeListener = null;

        // --- æ­¦è”µæ‘å±±å¸‚ æŒ‡å®šã®æ§‹æˆ (å­¦æ ¡ã‚³ãƒ¼ãƒ‰ãƒ»æ ¡åãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰) ---
        const SCHOOL_CONFIG = {
            '01': { name: 'ç¬¬ä¸€å°å­¦æ ¡', pw: 'portal01' },
            '02': { name: 'ç¬¬äºŒå°å­¦æ ¡', pw: 'portal02' },
            '03': { name: 'ç¬¬ä¸‰å°å­¦æ ¡', pw: 'portal03' },
            '04': { name: 'ç¬¬å››å°å­¦æ ¡', pw: 'portal04' },
            '07': { name: 'ç¬¬ä¸ƒå°å­¦æ ¡', pw: 'portal07' },
            '08': { name: 'ç¬¬å…«å°å­¦æ ¡', pw: 'portal08' },
            '09': { name: 'ç¬¬ä¹å°å­¦æ ¡', pw: 'portal09' },
            '10': { name: 'ç¬¬åå°å­¦æ ¡', pw: 'portal10' },
            '21': { name: 'é›·å¡šå°å­¦æ ¡', pw: 'portal21' },
            '11': { name: 'ç¬¬ä¸€ä¸­å­¦æ ¡', pw: 'portal11' },
            '12': { name: 'ç¬¬äºŒä¸­å­¦æ ¡', pw: 'portal12' },
            '13': { name: 'ç¬¬ä¸‰ä¸­å­¦æ ¡', pw: 'portal13' },
            '14': { name: 'ç¬¬å››ä¸­å­¦æ ¡', pw: 'portal14' },
            '15': { name: 'ç¬¬äº”ä¸­å­¦æ ¡', pw: 'portal15' }
        };

        const ADMIN_PASSWORD = 'admin123';
        const defaultLinks = [
            { name: 'eãƒ©ã‚¤ãƒ–ãƒ©ãƒª', url: "https://ela.education.ne.jp/students/" },
            { name: 'ãƒ‰ãƒªãƒ«ãƒ—ãƒ©ãƒãƒƒãƒˆ', url: "https://login.kobun.co.jp/student-login/?code=1134304" },
            { name: 'NHK for School', url: "https://www.nhk.or.jp/school/" }
        ];

        const startApp = async () => {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (user) { setupFirestoreListener(); }
                });
                await signInAnonymously(auth);
            } catch (error) {
                document.getElementById('main-title').textContent = "âš ï¸ æ¥ç¶šã‚¨ãƒ©ãƒ¼";
            }
        };

        function setupFirestoreListener() {
            if (!user || !db) return;
            if (unsubscribeListener) unsubscribeListener();

            // ãƒãƒƒã‚·ãƒ¥éƒ¨åˆ†ã®ã¿ã‚’å–å¾—ã—ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’é™¤å»
            const hashOnly = window.location.hash.split('?')[0];
            const rawHash = hashOnly.substring(1).toLowerCase().replace(/\/+$/, '').trim() || 'default';
            const currentKey = resolveKey(rawHash);
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'portals', currentKey);
            
            unsubscribeListener = onSnapshot(docRef, (docSnap) => {
                portalData[currentKey] = docSnap.exists() ? docSnap.data() : generateInitialData(currentKey);
                renderPortal(currentKey);
            }, (error) => {
                portalData[currentKey] = generateInitialData(currentKey);
                renderPortal(currentKey);
            });
        }

        function pad(num) { return num.toString().padStart(2, '0'); }

        function resolveKey(rawHash) {
            if (!rawHash || rawHash === 'default') return 'default';
            const matchXXgY = rawHash.match(/^(\d{1,2})g(\d{1})$/);
            if (matchXXgY) return `${pad(matchXXgY[1])}g${matchXXgY[2]}`;
            const matchXX = rawHash.match(/^(\d{1,2})$/);
            if (matchXX) return pad(matchXX[1]);
            return 'default';
        }

        function generateInitialData(key) {
            if (key === 'default') return { title: 'å…±é€šã‚³ãƒ³ãƒ†ãƒ³ãƒ„', links: defaultLinks, infoHtml: 'æ­¦è”µæ‘å±±å¸‚ å…±é€šãƒãƒ¼ã‚¿ãƒ«ã§ã™ã€‚' };
            const code = key.substring(0, 2);
            const config = SCHOOL_CONFIG[code];
            const name = config ? config.name : code + "æ ¡";
            if (key.includes('g')) {
                const grade = key.split('g')[1];
                return { title: `${name} ${grade}å¹´ç”Ÿ`, links: [...defaultLinks], infoHtml: `<p>${grade}å¹´ç”Ÿã®ãƒšãƒ¼ã‚¸ã¸ã‚ˆã†ã“ãï¼</p>` };
            }
            return { title: `${name} ãƒãƒ¼ã‚¿ãƒ«`, links: [...defaultLinks], infoHtml: `<p>${name}ã®å…±é€šæ¡ˆå†…ã§ã™ã€‚</p>` };
        }

        function renderPortal(key) {
            const data = portalData[key] || generateInitialData(key);
            document.getElementById('main-title').textContent = `å­¦ãƒˆãƒ“ãƒ© - ${data.title}`;
            document.getElementById('info-section').innerHTML = data.infoHtml || '';
            const container = document.getElementById('link-container');
            container.innerHTML = '';
            (data.links || []).forEach(link => {
                const btn = document.createElement('a');
                btn.href = link.url;
                btn.className = 'link-button';
                btn.innerHTML = `<span class="door-icon"></span><span class="button-text">${link.name}</span>`;
                btn.onclick = (e) => {
                    e.preventDefault();
                    btn.classList.add('opening');
                    setTimeout(() => { window.open(link.url, '_blank'); btn.classList.remove('opening'); }, 500);
                };
                container.appendChild(btn);
            });

            // ä¿®æ­£ï¼šURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆãƒãƒƒã‚·ãƒ¥ã®å¾Œã‚ã«?adminãŒã¤ãå ´åˆã¨ãƒãƒƒã‚·ãƒ¥ã®å‰ã«ä»˜ãå ´åˆã®ä¸¡æ–¹ã«å¯¾å¿œï¼‰
            const fullUrl = window.location.href;
            const hasAdminParam = fullUrl.includes('admin=') || fullUrl.includes('?admin') || fullUrl.includes('&admin');
            document.getElementById('edit-button').classList.toggle('hidden', !hasAdminParam);
        }

        window.handleEditClick = () => {
            const hashOnly = window.location.hash.split('?')[0];
            const rawHash = hashOnly.substring(1).toLowerCase() || 'default';
            const key = resolveKey(rawHash);
            const authCode = key.substring(0, 2);
            const required = (authCode === 'de' || key === 'default') ? ADMIN_PASSWORD : (SCHOOL_CONFIG[authCode] ? SCHOOL_CONFIG[authCode].pw : ADMIN_PASSWORD);
            const pw = prompt(`ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ› (#${key})`);
            if (pw === required) { showEditModal(key); }
            else if (pw !== null) { alert("èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
        };

        function showEditModal(key) {
            const modal = document.getElementById('edit-modal');
            document.getElementById('json-editor').value = JSON.stringify(portalData[key], null, 2);
            modal.style.display = 'flex';
        }

        window.saveChanges = async () => {
            const hashOnly = window.location.hash.split('?')[0];
            const key = resolveKey(hashOnly.substring(1));
            try {
                const newData = JSON.parse(document.getElementById('json-editor').value);
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'portals', key);
                await setDoc(docRef, newData);
                document.getElementById('edit-modal').style.display = 'none';
            } catch (e) { alert("å½¢å¼ã‚¨ãƒ©ãƒ¼"); }
        };

        window.addEventListener('hashchange', () => setupFirestoreListener());
        window.onload = startApp;
    </script>

    <style>
        body { font-family: 'M PLUS Rounded 1c', sans-serif; background: #f0f4f8; margin: 0; padding: 15px; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 25px; border-radius: 20px; box-shadow: 0 4px 25px rgba(0,0,0,0.1); }
        
        h1.section-title { 
            color: #0056b3; 
            border-bottom: 3px solid #0056b3; 
            padding-bottom: 12px; 
            font-size: 1.8rem; 
            text-align: center;
            margin-bottom: 25px;
        }

        .link-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 20px; 
            margin-top: 20px; 
        }

        .link-button { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 120px; 
            background: #ffffff; 
            border: 2px solid #0056b3; 
            border-radius: 12px; 
            border-top-left-radius: 40px; 
            border-top-right-radius: 40px; 
            text-decoration: none; 
            color: #0056b3; 
            font-weight: bold; 
            transition: 0.3s; 
            box-shadow: 0 5px 0 #0056b3; 
            position: relative;
        }

        .link-button:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 0 #0056b3; 
            background: #eef6ff; 
        }

        .door-icon { 
            width: 26px; 
            height: 36px; 
            background: #8B4513; 
            border: 2px solid #5D2E0C; 
            border-radius: 4px 4px 0 0; 
            margin-bottom: 8px; 
            transition: 0.4s; 
            transform-origin: left; 
            position: relative;
        }

        /* ãƒ‰ã‚¢ãƒãƒ– */
        .door-icon::after {
            content: '';
            position: absolute;
            right: 4px;
            top: 18px;
            width: 4px;
            height: 4px;
            background: #FFD700;
            border-radius: 50%;
        }

        .link-button.opening .door-icon { 
            transform: perspective(500px) rotateY(-110deg); 
            opacity: 0.6; 
        }

        .button-text {
            font-size: 1rem;
            text-align: center;
            padding: 0 10px;
        }

        .info-section { 
            margin-top: 35px; 
            padding: 20px; 
            background: #f8f9fa; 
            border-left: 5px solid #0056b3;
            border-radius: 8px; 
            text-align: left; 
            line-height: 1.8; 
        }

        .hidden { display: none !important; }

        #edit-button { 
            background: #28a745; 
            color: #fff; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 30px; 
            cursor: pointer; 
            font-weight: bold; 
            margin: 0 auto 20px auto; 
            display: block;
            box-shadow: 0 3px 0 #1e7e34;
            transition: 0.2s;
        }

        #edit-button:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        .modal-overlay { 
            position: fixed; 
            top:0; 
            left:0; 
            width:100%; 
            height:100%; 
            background:rgba(0,0,0,0.7); 
            display:none; 
            justify-content:center; 
            align-items:center; 
            z-index:100; 
        }

        .modal-content { 
            background:#fff; 
            padding:25px; 
            border-radius:15px; 
            width:90%; 
            max-width:700px; 
        }

        textarea { 
            width:100%; 
            height:350px; 
            font-family: 'Courier New', Courier, monospace; 
            margin-bottom:15px; 
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            border: none;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="main-title" class="section-title">âŒ› æº–å‚™ä¸­...</h1>
        <button id="edit-button" class="hidden" onclick="handleEditClick()">ğŸ›  ãƒãƒ¼ã‚¿ãƒ«ã‚’ç·¨é›†</button>
        <div class="link-grid" id="link-container"></div>
        <div class="info-section" id="info-section"></div>
    </div>
    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>ãƒãƒ¼ã‚¿ãƒ«è¨­å®šã®ç·¨é›† (JSON)</h3>
            <p style="font-size: 0.8rem; color: #666;">â€»ãƒªãƒ³ã‚¯åã‚„URLã‚’æ›¸ãæ›ãˆã¦ã€Œä¿å­˜ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
            <textarea id="json-editor"></textarea>
            <div class="modal-buttons">
                <button style="background: #ccc;" onclick="document.getElementById('edit-modal').style.display='none'">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button style="background: #0056b3; color: #fff;" onclick="saveChanges()">ä¿å­˜ã—ã¦æ›´æ–°</button>
            </div>
        </div>
    </div>
</body>
</html>
