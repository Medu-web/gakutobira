<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ãƒˆãƒ“ãƒ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Tailwind CSS ä»¥å¤–ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #f4f7f6;
            color: #333;
        }
        
        /* ãƒ‰ã‚¢ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .door-icon {
            position: relative;
            width: 24px;
            height: 32px;
            background-color: #a0522d;
            border: 2px solid #8B4513;
            border-radius: 4px 4px 0 0;
            margin-right: 15px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
            transform-origin: left center;
            transition: transform 0.5s ease-out, opacity 0.5s ease-out; 
            transform: rotateY(0deg);
        }
        .link-button.opening .door-icon {
            transform: rotateY(-110deg);
            opacity: 0;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="container max-w-4xl mx-auto p-4 md:p-8 bg-white shadow-xl rounded-xl">
        
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã¨èªè¨¼æƒ…å ± -->
        <header class="flex justify-between items-start mb-6 border-b pb-3">
            <div>
                <h1 class="text-3xl md:text-4xl font-extrabold text-blue-700 tracking-tight"><ruby>å­¦<rt class="text-gray-500 text-base font-normal">ã‚¬ã‚¯</rt></ruby>ãƒˆãƒ“ãƒ©</h1>
                <p class="text-sm text-gray-500 mt-1">å­¦ç¿’ã®æ‰‰ã‚’é–‹ã“ã†ï¼</p>
            </div>
            
            <div id="auth-status" class="text-right flex flex-col items-end">
                <p class="text-xs font-semibold text-gray-400" id="user-id-display">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ãƒ­ãƒ¼ãƒ‰ä¸­...</p>
                
                <!-- å…ˆç”Ÿï¼ˆç·¨é›†è€…ï¼‰å‘ã‘ã®ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
                <div id="editor-controls" class="mt-2 flex space-x-2 items-center hidden">
                    <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ (ç·¨é›†è€…ã®ã¿è¡¨ç¤º) -->
                    <button id="edit-button" class="px-3 py-1 bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-bold rounded-lg shadow-lg transition hidden" onclick="showEditModal()">
                        <span id="current-portal-key-display" class="font-normal text-xs mr-1">#default</span> **ç·¨é›†ãƒ¢ãƒ¼ãƒ‰**
                    </button>
                    <!-- ç·¨é›†ãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ (adminæ™‚ã®ã¿è¡¨ç¤º) -->
                    <button id="editor-login-button" class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white text-sm font-bold rounded-lg shadow-lg transition" onclick="toggleEditorLogin()">
                        ç·¨é›†ãƒ­ã‚°ã‚¤ãƒ³
                    </button>
                </div>
            </div>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div id="main-content">
            <h2 class="text-2xl font-bold text-blue-700 border-b-4 border-blue-600 pb-2 mb-6" id="main-section-title">ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ä¸­...</h2>
            
            <div id="link-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="col-span-full text-center py-10 text-gray-500" id="loading-message">
                    <div class="spinner mx-auto mb-3 border-blue-500 border-t-blue-700"></div>
                    <p>ãƒãƒ¼ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™...</p>
                </div>
            </div>
        </div>

        <!-- ç·Šæ€¥å¯¾å¿œã‚»ã‚¯ã‚·ãƒ§ãƒ³ (ãƒˆãƒ©ãƒ–ãƒ«å›é¿) -->
        <div class="mt-10 p-5 border-4 border-red-600 bg-red-50 rounded-xl shadow-lg">
            <h2 class="text-xl font-bold text-red-700 border-b-2 border-red-500 pb-2 mb-4">ğŸš¨ ç·Šæ€¥å¯¾å¿œã®æ‰‰</h2>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <a href="https://portal.office.com/" class="link-button flex items-center justify-center p-4 bg-yellow-500 hover:bg-yellow-600 text-gray-900 rounded-lg font-bold shadow-md transition">
                    <span class="door-icon bg-red-700 border-red-900"></span><span class="text-base text-center">Microsoftã®ã‚¹ã‚¿ãƒ¼ãƒˆãƒšãƒ¼ã‚¸<br>(Webç‰ˆ Office, Teams, OneDrive)</span>
                </a>
                <a href="#" class="link-button flex items-center justify-center p-4 bg-yellow-500 hover:bg-yellow-600 text-gray-900 rounded-lg font-bold shadow-md transition">
                    <span class="door-icon bg-red-700 border-red-900"></span><span class="text-base text-center">ã‚µã‚¤ãƒ³ã‚¤ãƒ³å¾©æ—§æ‰‹é †æ›¸<br>ï¼ˆãƒãƒ‹ãƒ¥ã‚¢ãƒ«ï¼‰</span>
                </a>
            </div>
        </div>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼æƒ…å ± -->
        <div class="mt-10 pt-5 border-t border-gray-300 text-center text-sm text-gray-500">
            <p>Portal System Powered by Firebase.</p>
        </div>
    </div>
    
    <!-- ------------------------------------- -->
    <!-- ãƒªãƒ³ã‚¯ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <!-- ------------------------------------- -->
    <div id="edit-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center hidden" role="dialog" aria-modal="true" aria-labelledby="edit-modal-title">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full p-6 m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start border-b pb-3 mb-4">
                <h3 id="edit-modal-title" class="text-xl font-bold text-blue-700">ãƒªãƒ³ã‚¯è¨­å®šã®ç·¨é›†</h3>
                <button onclick="hideEditModal()" class="text-gray-400 hover:text-gray-600 transition" aria-label="é–‰ã˜ã‚‹">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <p class="text-sm text-gray-600 mb-4">
                ç¾åœ¨ç·¨é›†ä¸­ã®ã‚­ãƒ¼: <span id="editing-key-display" class="font-mono bg-gray-100 px-1 rounded text-red-600"></span>
            </p>
            
            <div id="links-editor">
                <!-- ãƒªãƒ³ã‚¯å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
            </div>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button onclick="addLinkField()" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg transition shadow-md">
                    ãƒªãƒ³ã‚¯ã‚’è¿½åŠ 
                </button>
                <button onclick="saveEditedLinks()" id="save-button" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition shadow-md">
                    <span id="save-text">è¨­å®šã‚’ä¿å­˜</span>
                    <div id="save-spinner" class="spinner border-t-white hidden"></div>
                </button>
            </div>
        </div>
    </div>
    
    <!-- ------------------------------------- -->
    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <!-- ------------------------------------- -->
    <div id="password-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center hidden" role="dialog" aria-modal="true" aria-labelledby="password-modal-title">
        <div class="bg-white rounded-lg shadow-2xl max-w-sm w-full p-6 m-4">
            <h3 id="password-modal-title" class="text-xl font-bold text-blue-700 mb-4 border-b pb-2">ç·¨é›†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å…¥åŠ›</h3>
            <p class="text-sm text-gray-600 mb-4">å…ˆç”Ÿç”¨ã®å…±é€šãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            
            <input id="edit-password-input" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
            <p id="password-error" class="text-red-500 text-sm mt-2 hidden">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button onclick="hidePasswordModal()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold rounded-lg transition shadow-md">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button onclick="attemptLogin()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition shadow-md">
                    ãƒ­ã‚°ã‚¤ãƒ³
                </button>
            </div>
        </div>
    </div>

    <!-- ------------------------------------- -->
    <!-- Firebase SDKã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¨åˆæœŸåŒ– -->
    <!-- ------------------------------------- -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ã€é‡è¦ã€‘ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹ãŸã‚ã®å…±é€šãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
        const EDIT_PASSWORD = 'giga2025'; 
        const EDITOR_FLAG_KEY = 'isEditorAuthenticated';

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° (Canvasç’°å¢ƒã‹ã‚‰æä¾›ã•ã‚Œã‚‹ã‚‚ã®ã‚’å„ªå…ˆ)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // ----------------------------------------------------------------------
        // Firebase Config
        // ----------------------------------------------------------------------
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_API_KEY",
            authDomain: "gigaportal-editor.firebaseapp.com",
            projectId: "gigaportal-editor",
            storageBucket: "gigaportal-editor.firebasestorage.app",
            messagingSenderId: "969946487756",
            appId: "1:969946487756:web:fa4c4347d72de0b2dc9b69"
        };
        
        let app;
        let db;
        let auth;
        let userId = 'loading';
        let isAuthReady = false; 
        let isEditor = false; // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã¨adminãƒ•ãƒ©ã‚°ã§è¨­å®šã•ã‚Œã‚‹
        let currentHash = 'default';
        let currentDataKey = 'default'; // Firestoreã‹ã‚‰å–å¾—ã™ã‚‹ã‚­ãƒ¼ (adminã‚’é™¤å¤–ã—ãŸã‚‚ã®)

        // ----------------------------------------------------
        // Firestoreãƒ‘ã‚¹å®šç¾©
        // ----------------------------------------------------
        function getPortalConfigDocRef(docId) {
            return doc(db, 'artifacts', appId, 'public', 'data', 'portal_configs', docId);
        }

        /**
         * URLãƒãƒƒã‚·ãƒ¥ï¼ˆä¾‹: s/01/g6/adminï¼‰ã‚’Firestoreã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDï¼ˆä¾‹: s_01_g6ï¼‰ã«å¤‰æ›
         * @param {string} hash - URLãƒãƒƒã‚·ãƒ¥ï¼ˆ#ã‚’é™¤ãï¼‰
         * @returns {string} - Firestoreãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID
         */
        function getDocIdFromHash(hash) {
            const parts = hash.split('/');
            // æœ€å¾Œã®è¦ç´ ãŒ 'admin' ã®å ´åˆã¯é™¤å¤–
            if (parts[parts.length - 1].toLowerCase() === 'admin') {
                parts.pop(); 
            }
            return parts.join('_');
        }

        const initialPortalData = {
            'default': {
                title: 'ğŸ’¡ å…±é€šå­¦ç¿’ã®æ‰‰',
                links: [
                    { name: "eãƒ©ã‚¤ãƒ–ãƒ©ãƒª", url: "https://ela.education.ne.jp/students/" },
                    { name: "ãƒ‰ãƒªãƒ«ãƒ—ãƒ©ãƒãƒƒãƒˆ", url: "https://login.kobun.co.jp/student-login/?code=1134304" },
                    { name: "ã‚­ãƒ¼ãƒœãƒ¼å³¶ (ã‚¿ã‚¤ãƒ”ãƒ³ã‚°)", url: "https://kb-kentei.net/" },
                    { name: "æ•™è‚²å§”å“¡ä¼šWebã‚µã‚¤ãƒˆ", url: "https://example.com/edu-board" },
                ]
            },
            's_01_all': { title: 'ğŸ« ç¬¬ä¸€å°å­¦æ ¡ å…¨æ ¡å…±é€šã®æ‰‰', links: [ { name: "ä¸€å°-å­¦æ ¡ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›", url: "https://example.com/s01-info" }, { name: "ä¸€å°-å…ˆç”Ÿã¸ã®è³ªå•ãƒ•ã‚©ãƒ¼ãƒ ", url: "https://forms.gle/s01-q-form" } ] },
            's_12_g7': { title: 'ğŸ“ ç¬¬äºŒä¸­å­¦æ ¡ 7å¹´ç”Ÿã®æ‰‰', links: [ { name: "7å¹´ è‹±èªå­¦ç¿’ã‚µã‚¤ãƒˆ", url: "https://example.com/jhs2-g7-english" }, { name: "7å¹´ ç†ç§‘å®Ÿé¨“è¨˜éŒ²", url: "https://example.com/jhs2-g7-science" } ] },
        };
        
        // ----------------------------------------------------
        // FirebaseåˆæœŸåŒ–ã¨èªè¨¼
        // ----------------------------------------------------
        function initializeFirebase() {
            try {
                if (!firebaseConfig || !firebaseConfig.projectId) {
                    console.warn("Firebase Configæœªè¨­å®š");
                    return; 
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¯çŸ­ç¸®ã—ã¦è¡¨ç¤º
                        document.getElementById('user-id-display').textContent = `ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId.substring(0, 8)}...`;
                        
                        isAuthReady = true;
                        
                        // ç·¨é›†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
                        checkEditorStatus();

                        renderPortal();
                        
                    } else {
                        // åŒ¿åèªè¨¼ã§ã‚¢ã‚¯ã‚»ã‚¹ã‚’è©¦è¡Œ
                        await handleSignIn();
                    }
                });

            } catch (error) {
                console.error("Firebaseã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
            }
        }
        
        async function handleSignIn() {
             try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
                document.getElementById('user-id-display').textContent = `èªè¨¼ã‚¨ãƒ©ãƒ¼`;
            }
        }
        
        // ----------------------------------------------------
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†
        // ----------------------------------------------------
        function checkEditorStatus() {
            // localStorageã«ãƒ•ãƒ©ã‚°ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            isEditor = localStorage.getItem(EDITOR_FLAG_KEY) === 'true';
            updateEditorUI();
        }

        function updateEditorUI() {
            const editorControls = document.getElementById('editor-controls');
            const editButton = document.getElementById('edit-button');
            const loginButton = document.getElementById('editor-login-button');
            
            // adminãƒ‘ã‚¹ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ã€ãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            const isAdminPath = window.location.hash.toLowerCase().endsWith('/admin');
            
            if (isAdminPath) {
                editorControls.classList.remove('hidden');
                if (isEditor) {
                    // ç·¨é›†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿
                    editButton.classList.remove('hidden');
                    loginButton.textContent = 'ç·¨é›†ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ';
                    loginButton.classList.remove('bg-gray-500');
                    loginButton.classList.add('bg-red-500', 'hover:bg-red-600');
                } else {
                    // adminãƒ‘ã‚¹ã ãŒæœªãƒ­ã‚°ã‚¤ãƒ³
                    editButton.classList.add('hidden');
                    loginButton.textContent = 'ç·¨é›†ãƒ­ã‚°ã‚¤ãƒ³';
                    loginButton.classList.add('bg-gray-500');
                    loginButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                }
            } else {
                // adminãƒ‘ã‚¹ã§ã¯ãªã„å ´åˆï¼ˆå…ç«¥ç”Ÿå¾’å‘ã‘ç”»é¢ï¼‰
                editorControls.classList.add('hidden');
            }
        }

        window.toggleEditorLogin = function() {
            if (isEditor) {
                // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
                localStorage.removeItem(EDITOR_FLAG_KEY);
                isEditor = false;
                updateEditorUI();
            } else {
                // ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼‰å‡¦ç†
                showPasswordModal();
            }
        }
        
        window.showPasswordModal = function() {
            document.getElementById('edit-password-input').value = '';
            document.getElementById('password-error').classList.add('hidden');
            document.getElementById('password-modal').classList.remove('hidden');
        }

        window.hidePasswordModal = function() {
            document.getElementById('password-modal').classList.add('hidden');
        }

        window.attemptLogin = function() {
            const input = document.getElementById('edit-password-input').value;
            const errorElement = document.getElementById('password-error');
            
            if (input === EDIT_PASSWORD) {
                localStorage.setItem(EDITOR_FLAG_KEY, 'true');
                isEditor = true;
                updateEditorUI();
                hidePasswordModal();
                // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸå¾Œã€ç·¨é›†ãƒœã‚¿ãƒ³ãŒè‡ªå‹•è¡¨ç¤ºã•ã‚Œã€æŠ¼ã™ã“ã¨ã§ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã
            } else {
                errorElement.classList.remove('hidden');
            }
        }
        
        // ----------------------------------------------------
        // Firestoreã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼)
        // ----------------------------------------------------
        let unsubscribe = null; 

        async function loadLinks(docId, originalHash) {
            if (!isAuthReady) return;

            // å…ç«¥ç”Ÿå¾’ãŒè¦‹ã‚‹URLã¯originalHashã€ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚­ãƒ¼ã¯docId
            currentDataKey = docId; 

            if (unsubscribe) {
                unsubscribe();
                unsubscribe = null;
            }

            const docRef = getPortalConfigDocRef(docId);

            unsubscribe = onSnapshot(docRef, async (docSnap) => {
                let data = null;

                if (docSnap.exists()) {
                    data = docSnap.data();
                } else {
                    // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨
                    const initialData = initialPortalData[docId] || initialPortalData['default'];
                    if (initialData) {
                        data = initialData;
                        await setDoc(docRef, initialData, { merge: true }).catch(e => console.error("åˆæœŸãƒ‡ãƒ¼ã‚¿ä¿å­˜å¤±æ•—:", e));
                    }
                }

                if (data) {
                    updatePortalUI(data, originalHash, docId);
                } else {
                    // æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    updatePortalUI(initialPortalData['default'], originalHash, 'default');
                }
            }, (error) => {
                console.error("Firestore onSnapshot ã‚¨ãƒ©ãƒ¼:", error);
                const fallbackData = initialPortalData[docId] || initialPortalData['default'];
                updatePortalUI(fallbackData, originalHash, 'default');
            });
        }
        
        // ----------------------------------------------------
        // ãƒãƒ¼ã‚¿ãƒ«UIã®æ›´æ–°
        // ----------------------------------------------------
        function updatePortalUI(data, originalHash, docId) {
            const container = document.getElementById('link-container');
            const titleElement = document.getElementById('main-section-title');
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã«è¡¨ç¤ºã™ã‚‹ã‚­ãƒ¼ï¼ˆadminã‚’é™¤ã„ãŸãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼ï¼‰
            document.getElementById('current-portal-key-display').textContent = `#${docId.replace(/_/g, '/')}`;

            // ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ã«è¡¨ç¤ºã™ã‚‹ã‚­ãƒ¼ï¼ˆå…ç«¥ç”Ÿå¾’å‘ã‘ã®å…ƒã®URLãƒãƒƒã‚·ãƒ¥ï¼‰
            const keyDisplay = docId !== getDocIdFromHash(originalHash) ? ` (DB: ${docId.replace(/_/g, '/')})` : '';
            titleElement.innerHTML = `<span class="text-2xl font-bold text-blue-700">${data.title}</span> <span style="font-size: 0.7em; color: #888; display: block; margin-top: 5px;">(Key: #${originalHash}${keyDisplay})</span>`;
            
            container.innerHTML = '';

            if (data.links && data.links.length > 0) {
                 data.links.forEach(link => {
                    const linkElement = document.createElement('a');
                    linkElement.href = link.url;
                    linkElement.className = 'link-button flex items-center p-4 bg-blue-50 hover:bg-blue-100 text-blue-800 rounded-lg font-bold shadow-md transition';
                    
                    linkElement.innerHTML = `<span class="door-icon"></span><span class="text-base text-left">${link.name}</span>`;
                    container.appendChild(linkElement);
                });
            } else {
                container.innerHTML = `<div class="col-span-full text-center py-10 text-gray-500">ã“ã®ãƒãƒ¼ã‚¿ãƒ«ã«ã¯ã¾ã ãƒªãƒ³ã‚¯ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã€Œç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã€ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>`;
            }

            attachAnimationListeners();
        }

        // ----------------------------------------------------
        // URLãƒãƒƒã‚·ãƒ¥å‡¦ç†ã¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯
        // ----------------------------------------------------
        function renderPortal() {
            if (!isAuthReady) return;

            // 1. URLãƒãƒƒã‚·ãƒ¥ã®å–å¾—ã¨adminãƒã‚§ãƒƒã‚¯
            const hash = window.location.hash.substring(1).toLowerCase();
            let finalHash = hash || 'default';
            
            // 2. ãƒ‡ãƒ¼ã‚¿å–å¾—ç”¨ã®ã‚­ãƒ¼ã‚’æ±ºå®š
            const docId = getDocIdFromHash(finalHash);

            currentHash = finalHash; 
            
            // 3. ç·¨é›†UIã‚’æ›´æ–°ï¼ˆadminãƒ‘ã‚¹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
            updateEditorUI();
            
            // 4. ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
            loadLinks(docId, finalHash);
        }

        // ----------------------------------------------------
        // UIã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†
        // ----------------------------------------------------
        const animationDuration = 500;
        
        function handleLinkClick(e) {
            
            if (this.href.includes('[')) { 
                e.preventDefault();
                return;
            }
            
            if (this.href.endsWith('#') || this.href === '') {
                 e.preventDefault();
            } else {
                 e.preventDefault();
            }

            const targetUrl = this.href;
            this.classList.add('opening');

            setTimeout(() => {
                if (!this.href.endsWith('#') && this.href !== '') {
                    window.open(targetUrl, '_blank');
                }
                setTimeout(() => {
                     this.classList.remove('opening');
                }, 100);
            }, animationDuration + 50); 
        }

        function attachAnimationListeners() {
            const linkButtons = document.querySelectorAll('.link-button');
            linkButtons.forEach(button => {
                button.removeEventListener('click', handleLinkClick); 
                button.addEventListener('click', handleLinkClick);
            });
        }
        
        // ----------------------------------------------------
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®é–¢æ•°
        // ----------------------------------------------------
        let editingLinksData = [];
        let editingTitle = '';
        
        window.showEditModal = function() {
            if (!isEditor) return; 

            document.getElementById('editing-key-display').textContent = `#${currentDataKey.replace(/_/g, '/')}`;
            
            const docRef = getPortalConfigDocRef(currentDataKey);

            getDoc(docRef).then(docSnap => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    editingLinksData = data.links || [];
                    editingTitle = data.title || '';
                } else {
                    const initialData = initialPortalData[currentDataKey] || initialPortalData['default'];
                    editingLinksData = initialData.links || [];
                    editingTitle = initialData.title || '';
                }
                
                document.getElementById('edit-modal-title').textContent = `ãƒªãƒ³ã‚¯è¨­å®šã®ç·¨é›† (${editingTitle})`;
                renderLinkEditor();
                document.getElementById('edit-modal').classList.remove('hidden');
            }).catch(e => {
                console.error("ç·¨é›†ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—:", e);
                editingLinksData = [];
                editingTitle = 'æ–°ã—ã„ãƒãƒ¼ã‚¿ãƒ«';
                renderLinkEditor();
                document.getElementById('edit-modal').classList.remove('hidden');
            });
        }

        window.hideEditModal = function() {
            document.getElementById('edit-modal').classList.add('hidden');
        }

        function renderLinkEditor() {
            const editor = document.getElementById('links-editor');
            const titleHtml = `
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">ãƒãƒ¼ã‚¿ãƒ«ã‚¿ã‚¤ãƒˆãƒ« (ä¾‹: 1å¹´ç”Ÿã®æ‰‰)</label>
                    <input id="edit-title" type="text" value="${editingTitle}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            `;
            let linksHtml = editingLinksData.map((link, index) => {
                return `
                    <div class="link-row flex space-x-2 items-center mb-3 p-2 border border-gray-200 rounded-md shadow-sm" data-index="${index}">
                        <input type="text" placeholder="ãƒªãƒ³ã‚¯å" value="${link.name}" class="w-1/3 border border-gray-300 rounded-md p-2 text-sm focus:ring-blue-500 focus:border-blue-500" data-field="name" oninput="updateLinkData(event)">
                        <input type="url" placeholder="URL (https://...)" value="${link.url}" class="w-1/2 border border-gray-300 rounded-md p-2 text-sm focus:ring-blue-500 focus:border-blue-500" data-field="url" oninput="updateLinkData(event)">
                        <button type="button" class="w-1/6 p-2 rounded-md hover:bg-red-100 transition" onclick="removeLinkField(this.closest('.link-row'))">
                            <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3m-4 0h12"></path></svg>
                        </button>
                    </div>
                `;
            }).join('');
            
            editor.innerHTML = titleHtml + linksHtml;
        }

        window.addLinkField = function() {
            const newLink = { name: '', url: '' };
            editingLinksData.push(newLink);
            const newIndex = editingLinksData.length - 1;
            
            const editor = document.getElementById('links-editor');
            const newRow = document.createElement('div');
            newRow.className = 'link-row flex space-x-2 items-center mb-3 p-2 border border-gray-200 rounded-md shadow-sm';
            newRow.dataset.index = newIndex;
            newRow.innerHTML = `
                <input type="text" placeholder="ãƒªãƒ³ã‚¯å" value="${newLink.name}" class="w-1/3 border border-gray-300 rounded-md p-2 text-sm focus:ring-blue-500 focus:border-blue-500" data-field="name" oninput="updateLinkData(event)">
                <input type="url" placeholder="URL (https://...)" value="${newLink.url}" class="w-1/2 border border-gray-300 rounded-md p-2 text-sm focus:ring-blue-500 focus:border-blue-500" data-field="url" oninput="updateLinkData(event)">
                <button type="button" class="w-1/6 p-2 rounded-md hover:bg-red-100 transition" onclick="removeLinkField(this.closest('.link-row'))">
                    <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3m-4 0h12"></path></svg>
                </button>
            `;
            editor.appendChild(newRow);
        }

        window.updateLinkData = function(e) {
            const row = e.target.closest('.link-row');
            const index = parseInt(row.dataset.index);
            const field = e.target.dataset.field;
            
            if (editingLinksData[index]) {
                editingLinksData[index][field] = e.target.value;
            }
        }

        window.removeLinkField = function(rowElement) {
            const indexToRemove = parseInt(rowElement.dataset.index);
            editingLinksData.splice(indexToRemove, 1);
            rowElement.remove();
            
            const editor = document.getElementById('links-editor');
            editor.querySelectorAll('.link-row').forEach((row, newIndex) => {
                row.dataset.index = newIndex;
            });
        }

        window.saveEditedLinks = async function() {
            if (!isEditor) return; 

            const saveButton = document.getElementById('save-button');
            const saveText = document.getElementById('save-text');
            const saveSpinner = document.getElementById('save-spinner');

            saveText.classList.add('hidden');
            saveSpinner.classList.remove('hidden');
            saveButton.disabled = true;

            try {
                const newTitle = document.getElementById('edit-title').value;
                const newLinks = editingLinksData.filter(link => link && (link.name?.trim() !== '' || link.url?.trim() !== ''));

                const dataToSave = {
                    title: newTitle,
                    links: newLinks
                };

                const docRef = getPortalConfigDocRef(currentDataKey);
                
                await setDoc(docRef, dataToSave);
                
                saveText.textContent = 'ä¿å­˜å®Œäº†ï¼';
                saveText.classList.remove('hidden');
                
                setTimeout(() => {
                    hideEditModal();
                    saveText.textContent = 'è¨­å®šã‚’ä¿å­˜';
                    saveSpinner.classList.add('hidden');
                    saveButton.disabled = false;
                }, 1000);

            } catch (error) {
                console.error("è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
                saveText.textContent = 'ä¿å­˜å¤±æ•— (F12ã§ç¢ºèª)';
                saveText.classList.remove('hidden');
                
                setTimeout(() => {
                    saveText.textContent = 'è¨­å®šã‚’ä¿å­˜';
                    saveSpinner.classList.add('hidden');
                    saveButton.disabled = false;
                }, 2000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
             initializeFirebase();
             window.addEventListener('hashchange', renderPortal);
        });
        
    </script>
</body>
</html>
